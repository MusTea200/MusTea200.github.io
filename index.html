<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Köy ve Savaş Oyunu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide-react@0.378.0/dist/lucide-react.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #0c1a3a 100%);
            overflow-y: hidden;
            overflow-x: hidden;
        }
        .form-container {
            background: rgba(17, 24, 39, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tab-button { transition: all 0.3s ease; }
        .tab-button.active { background-color: #2563eb; color: white; }
        .tab-button:not(.active) { background-color: transparent; color: #9ca3af; }
        .btn-primary { background: #2563eb; transition: background-color 0.3s ease; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-primary:disabled { background: #4b5563; cursor: not-allowed; }
        .hidden { display: none; }
        .gender-btn.active { background-color: #2563eb; box-shadow: 0 0 10px #2563eb; }
        .color-swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s ease, border-color 0.2s ease; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.selected { border-color: #ffffff; transform: scale(1.1); }
        .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.3s; }
        .has-tooltip:hover .tooltip { visibility: visible; opacity: 1; }
        
        .character-sheet-modal { transition: opacity 0.3s ease-in-out; }
        .character-sheet-window { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease-in-out; }
        .modal-closed .character-sheet-window {
            transform-origin: top left;
            transform: scale(0.8);
            opacity: 0;
        }
        .inventory-slot {
            background-color: rgba(17, 24, 39, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            aspect-ratio: 1 / 1;
            transition: background-color 0.2s;
            position: relative;
            display: flex; /* İçeriği ortalamak için eklendi */
            align-items: center;
            justify-content: center;
        }
        .inventory-slot svg {
            pointer-events: none;
        }
        .equipment-slot.drag-over {
            border-color: #3b82f6;
            box-shadow: 0 0 10px #3b82f6;
        }

        .inventory-slot:hover { background-color: rgba(30, 41, 59, 0.8); }
        .exp-bar-fill {
             background: linear-gradient(90deg, #60a5fa 0%, #2563eb 100%);
             transition: width 0.5s ease-in-out;
        }
        .stat-plus-btn {
            background-color: #1e40af; color: white;
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.2rem;
            transition: background-color 0.2s;
        }
        .stat-plus-btn:hover:not(:disabled) { background-color: #2563eb; }
        .stat-plus-btn:disabled { background-color: #374151; cursor: not-allowed; }
        .stat-info-btn {
            width: 20px; height: 20px;
            border-radius: 50%; background-color: #4b5563;
            color: white; font-size: 0.8rem;
            display: flex; align-items: center; justify-content: center;
            cursor: help;
        }
        #stat-tooltip {
            transition: opacity 0.2s ease-in-out;
            pointer-events: none;
        }
        #game-screen {
            background-image: url('https://images.unsplash.com/photo-1542273917363-3b1817f69a2d?q=80&w=2074&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            width: 100%;
            height: 100%;
            position: absolute;
        }
        .location-button {
            background-color: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 1rem;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            color: white;
            padding: 1rem;
        }
        .location-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.5);
            border-color: rgba(96, 165, 250, 0.8);
        }
        .game-sub-screen {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(12, 26, 58, 0.8);
            backdrop-filter: blur(8px);
        }
        .nav-arrow {
            position: absolute;
            background: rgba(17, 24, 39, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .nav-arrow:hover {
            background: rgba(30, 64, 175, 0.8);
            border-color: #60a5fa;
        }

        #energy-bar-container {
            width: 352px; /* 5 * 64px (slot) + 4 * 8px (gap) */
            height: 30px;
            background-color: rgba(17, 24, 39, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-bottom: none;
            border-top-left-radius: 9999px;
            border-top-right-radius: 9999px;
            padding: 4px;
            display: flex;
            align-items: center;
        }
        #energy-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #fde047 0%, #f59e0b 100%);
            border-radius: 9999px;
            transition: width 0.5s ease;
            position: relative;
        }
        #energy-bar-text {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: #422006;
            font-weight: bold;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .chest-page-btn.active {
            background-color: #2563eb;
        }
        .upgrade-card {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }
        .upgrade-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.4);
        }
        /* Market Trade Screen Styles */
        #market-trade-screen .market-category-btn {
            transition: background-color 0.2s, color 0.2s;
        }
        #market-trade-screen .market-category-btn.active {
            background-color: #2563eb;
            color: white;
        }
        /* ... mevcut stilleriniz ... */
        #market-trade-screen .market-item {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative; /* Rarity border için eklendi */
        }
        
        /* YENİ EKLENEN STİLLER */
        .rarity-border {
            content: '';
            position: absolute;
            inset: -1px; /* Kenarlığın tam oturması için */
            border-radius: 0.5rem; /* .rounded-lg ile aynı */
            z-index: -1;
            background: conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops));
            opacity: 0.6;
        }

        .inventory-slot.selected {
            box-shadow: 0 0 10px 2px #ef4444;
            border-color: #ef4444;
        }
        
        #item-tooltip {
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            pointer-events: none; /* Tooltip'in fare olaylarını engellememesi için */
            transform: scale(0.95);
        }
        #item-tooltip.visible {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>
<body class="text-white">

    <div id="app-container" class="min-h-screen h-screen flex items-center justify-center p-4 relative">
        <!-- AUTHENTICATION AND CHARACTER CREATION SCREENS (UNCHANGED) -->
        <div id="auth-screen" class="w-full max-w-md">
            <div class="form-container rounded-2xl p-8 shadow-2xl">
                <h1 class="text-3xl font-bold text-center mb-6">Oyun Projesi</h1>
                <div class="flex border border-gray-700 rounded-lg p-1 mb-6">
                    <button id="login-tab-button" class="tab-button active w-1/2 rounded-md py-2 font-semibold">Giriş Yap</button>
                    <button id="register-tab-button" class="tab-button w-1/2 rounded-md py-2 font-semibold">Kayıt Ol</button>
                </div>
                <form id="login-form">
                    <div class="space-y-4">
                        <input type="text" id="login-username" placeholder="Kullanıcı Adı" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <input type="password" id="login-password" placeholder="Şifre" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="btn-primary w-full text-white font-bold py-3 rounded-lg mt-6">Giriş Yap</button>
                </form>
                <form id="register-form" class="hidden">
                    <div class="space-y-4">
                        <input type="text" id="register-username" placeholder="Kullanıcı Adı" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <input type="password" id="register-password" placeholder="Şifre" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="btn-primary w-full text-white font-bold py-3 rounded-lg mt-6">Kayıt Ol</button>
                </form>
                <p id="auth-message" class="text-center text-red-400 mt-4 h-5"></p>
                <div class="relative flex py-5 items-center">
                    <div class="flex-grow border-t border-gray-600"></div><span class="flex-shrink mx-4 text-gray-400">Veya</span><div class="flex-grow border-t border-gray-600"></div>
                </div>
                <button id="google-signin-button" class="w-full bg-white text-gray-800 font-semibold py-3 rounded-lg flex items-center justify-center space-x-2 hover:bg-gray-200 transition">
                    <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#4285F4" d="M24 9.5c3.9 0 6.8 1.6 8.4 3.1l6.3-6.3C34.9 2.6 30 .5 24 .5 14.9.5 7.7 5.8 4.4 13.5l7.1 5.5C13.2 13.5 18.2 9.5 24 9.5z"></path><path fill="#34A853" d="M46.5 24.5c0-1.6-.1-3.2-.4-4.7H24v9h12.7c-.5 2.9-2.2 5.4-4.7 7.1l6.3 6.3c3.7-3.4 5.8-8.3 5.8-14z"></path><path fill="#FBBC05" d="M11.5 29.5c-.5-1.5-.8-3.1-.8-4.8s.3-3.3.8-4.8l-7.1-5.5C2.6 18.2.5 22.9.5 28.3c0 5.4 2.1 10.1 5.9 13.5l7.1-5.5c-1.7-1.4-2.8-3.4-3-5.8z"></path><path fill="#EA4335" d="M24 47.5c5.9 0 10.8-1.9 14.4-5.2l-6.3-6.3c-2 1.4-4.5 2.2-7.1 2.2-5.9 0-10.9-4-12.7-9.5l-7.1 5.5C7.7 42.2 14.9 47.5 24 47.5z"></path></svg>
                    <span>Google ile Giriş Yap</span>
                </button>
            </div>
        </div>
        <div id="character-creation-screen" class="hidden w-full max-w-2xl">
            <div class="form-container rounded-2xl p-8 shadow-2xl">
                <h1 class="text-3xl font-bold text-center mb-6">Karakterini Yarat</h1>
                <p id="reset-char-warning" class="text-center text-yellow-400 mb-4 h-5"></p>
                <div class="flex flex-col md:flex-row items-center justify-around gap-8">
                    <div class="w-48 h-72 bg-gray-900/50 rounded-lg flex items-center justify-center p-2 border border-gray-700">
                        <svg id="character-preview" viewBox="0 0 200 300" class="w-full h-full">
                            <g id="character-master-group" transform="translate(-60, -20) scale(1.6)">
                                <g id="hair-female-back-group" class="hidden"><path id="hair-female-back" fill="#5D4037" d="M80 80 h40 v80 a20,20 0 0 1 -40 0 Z" /></g>
                                <g id="body-group">
                                    <g id="body-male">
                                        <g class="character-skin-part" fill="#e0ac69"><path d="M70 135 h-10 v60 h10 Z" /><path d="M130 135 h10 v60 h-10 Z" /></g>
                                        <g><path id="outfit-male" fill="#4CAF50" d="M70,135 v60 h60 v-60 c0,-15 -10,-20 -30,-20 s-30,5 -30,20 Z" /><path id="collar-male" fill="#1e3a8a" d="M100,118 a12,8 0 0,1 0,12 a12,8 0 0,1 0,-12 Z" /><path id="pocket-male" fill="#388E3C" d="M105 140 h20 l-10 15 Z" /></g>
                                    </g>
                                    <g id="body-female" class="hidden">
                                        <g class="character-skin-part" fill="#e0ac69"><path d="M72 135 h-10 v60 h10 Z" /><path d="M128 135 h10 v60 h-10 Z" /></g>
                                        <g><path id="outfit-female" fill="#4CAF50" d="M72,135 C75,160 75,170 72,195 h56 c-3,-25 -3,-35 0,-60 c0,-15 -10,-20 -28,-20 s-28,5 -28,20 Z" /><path id="collar-female" fill="#1e3a8a" d="M100,118 a12,8 0 0,1 0,12 a12,8 0 0,1 0,-12 Z" /><path id="pocket-female" fill="#388E3C" d="M105 140 h20 l-10 15 Z" /></g>
                                    </g>
                                </g>
                                <g id="head-group" transform="translate(0, -5)">
                                    <path class="character-skin-part" fill="#e0ac69" d="M100,25 C75,25 60,45 60,70 C60,95 75,115 100,115 C125,115 140,95 140,70 C140,45 125,25 100,25 Z" />
                                    <g fill="white"><circle id="eye-left" cx="90" cy="75" r="6" /><circle id="eye-right" cx="110" cy="75" r="6" /></g>
                                    <g fill="black"><circle id="pupil-left" cx="90" cy="75" r="3" /><circle id="pupil-right" cx="110" cy="75" r="3" /></g>
                                    <g id="hair-male-front-group"><path id="hair-male" fill="#5D4037" d="M80,35 L85,20 L90,35 L95,20 L100,35 L105,20 L110,35 L115,20 L120,35 C110,45 90,45 80,35 Z" /></g>
                                    <g id="hair-female-front-group" class="hidden" transform="translate(0, -16)"><path id="hair-female-front" fill="#5D4037" d="M65,65 C70,45 90,40 100,40 C110,40 130,45 135,65 C125,85 75,85 65,65 Z" /></g>
                                </g>
                            </g>
                        </svg>
                    </div>
                    <div class="w-full md:w-1/2">
                        <form id="character-creation-form" class="space-y-4">
                            <div id="in-game-name-container">
                                <label for="character-name-input" class="font-semibold text-gray-300">Oyun İçi Adın</label>
                                <input type="text" id="character-name-input" placeholder="Maks. 16 karakter" maxlength="16" required class="mt-2 w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <p id="name-validation-message" class="text-red-400 text-sm mt-1 h-4"></p>
                            </div>
                            <div id="in-game-name-display" class="hidden">
                                <label class="font-semibold text-gray-300">Oyun İçi Adın</label>
                                <p class="mt-2 text-lg font-bold bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-gray-400">
                                    <span id="locked-in-game-name"></span> (Değiştirilemez)
                                </p>
                            </div>
                            <div><label class="font-semibold text-gray-300">Cinsiyet</label><div class="flex gap-2 mt-2"><button type="button" data-gender="male" class="gender-btn active w-full bg-gray-700 p-2 rounded-lg transition">Erkek</button><button type="button" data-gender="female" class="gender-btn w-full bg-gray-700 p-2 rounded-lg transition">Kadın</button></div></div>
                            <div><label class="font-semibold text-gray-300">Ten Rengi</label><div id="skin-color-swatches" class="flex gap-2 mt-2 flex-wrap"></div></div>
                            <div><label class="font-semibold text-gray-300">Saç Rengi</label><div id="hair-color-swatches" class="flex gap-2 mt-2 flex-wrap"></div></div>
                        </form>
                    </div>
                </div>
                <button id="create-character-button" type="submit" form="character-creation-form" class="btn-primary w-full text-white font-bold py-3 rounded-lg mt-8">Karakteri Oluştur</button>
            </div>
        </div>
        <div id="main-menu-screen" class="hidden text-center">
            <h1 class="text-5xl font-bold mb-2">Hoş Geldin, <span id="user-display"></span>!</h1>
            <p class="text-gray-400 mb-12">UID: <span id="uid-display" class="text-xs"></span></p>
            <div class="space-y-4 flex flex-col items-center">
                <button id="start-game-button" class="btn-primary w-full max-w-xs text-xl font-bold py-4 px-6 rounded-lg">Oyuna Başla</button>
            </div>
        </div>
        
        <div id="game-screen" class="hidden">
            <!-- Village View -->
            <div id="village-view">
                 <button id="home-button" class="location-button absolute" style="top: 40%; left: 25%;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2 mx-auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    <span class="font-bold">Ev</span>
                </button>
                 <button id="arena-button" class="location-button absolute" style="top: 20%; left: 60%;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2 mx-auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l4 4-1 7 3 3-4 4-7-1 3-3-1-7 4-4z"></path><path d="M12 2l-4 4 1 7-3 3 4 4 7-1-3-3 1-7-4-4z"></path></svg>
                    <span class="font-bold">Arena</span>
                </button>
                 <button id="market-button" class="location-button absolute" style="top: 65%; left: 55%;">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-2 mx-auto" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0-4.4-3.6-8-8-8s-8 3.6-8 8 3.6 8 8 8 8-3.6 8-8z"></path><path d="M15 10c0 1.7-1.3 3-3 3s-3-1.3-3-3 1.3-3 3-3 3 1.3 3 3z"></path><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="M22 12h-2"></path><path d="M4 12H2"></path></svg>
                    <span class="font-bold">AVM</span>
                </button>
            </div>
            <!-- Home Screen -->
            <div id="home-screen" class="game-sub-screen hidden w-full h-full">
                <h1 class="text-4xl font-bold mb-8">Ev</h1>
                <div class="text-center space-y-4">
                    <button class="btn-primary p-4 rounded-lg">Yatak: Can ve Enerji yeniler.</button>
                    <button id="open-chest-button" class="btn-primary p-4 rounded-lg">Sandık: Eşyalarını depola.</button>
                    <button id="open-wardrobe-button" class="btn-primary p-4 rounded-lg flex items-center justify-center gap-3">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M12 22a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2h-1.5a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h1.5z"/><path d="M8.5 2v12.5a2 2 0 0 0 2 2h0a2 2 0 0 0 2-2V2"/><path d="M15.5 2v12.5a2 2 0 0 1-2 2h0a2 2 0 0 1-2-2V2"/></svg>
    <span>Gardırop: Görünümünü Değiştir</span>
</button>
                </div>
                <button class="nav-arrow back-to-village-button" style="top: 5%; left: 50%; transform: translateX(-50%);" title="Köy'e Geri Dön">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                </button>
                <button class="nav-arrow" id="go-to-garden" style="left: 5%; top: 50%; transform: translateY(-50%);">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <button class="nav-arrow" id="go-to-garage" style="right: 5%; top: 50%; transform: translateY(-50%);">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
                <button class="nav-arrow" id="go-to-basement" style="bottom: 15%; left: 50%; transform: translateX(-50%);">
                     <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
            </div>
            <div id="wardrobe-screen" class="game-sub-screen hidden w-full h-full">
    <div class="form-container rounded-2xl p-8 shadow-2xl w-full max-w-2xl relative">
        <button class="nav-arrow back-to-home-button" style="top: -80px; left: 50%; transform: translateX(-50%);" title="Eve Geri Dön">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
        </button>

        <h1 class="text-3xl font-bold text-center mb-6">Gardırop</h1>
        <div class="flex flex-col md:flex-row items-center justify-around gap-8">
            <div class="w-48 h-72 bg-gray-900/50 rounded-lg flex items-center justify-center p-2 border border-gray-700">
                <svg id="wardrobe-character-preview" viewBox="0 0 200 300" class="w-full h-full"></svg>
            </div>
            <div class="w-full md:w-1/2" id="wardrobe-options-container">
                <div class="space-y-4">
                    <div>
                        <label class="font-semibold text-gray-300">Cinsiyet</label>
                        <div id="wardrobe-gender-buttons" class="flex gap-2 mt-2">
                            <button type="button" data-gender="male" class="gender-btn w-full bg-gray-700 p-2 rounded-lg transition">Erkek</button>
                            <button type="button" data-gender="female" class="gender-btn w-full bg-gray-700 p-2 rounded-lg transition">Kadın</button>
                        </div>
                    </div>
                    <div>
                        <label class="font-semibold text-gray-300">Ten Rengi</label>
                        <div id="wardrobe-skin-color-swatches" class="flex gap-2 mt-2 flex-wrap"></div>
                    </div>
                    <div>
                        <label class="font-semibold text-gray-300">Saç Rengi</label>
                        <div id="wardrobe-hair-color-swatches" class="flex gap-2 mt-2 flex-wrap"></div>
                    </div>
                </div>
            </div>
        </div>
        <button id="confirm-wardrobe-change-button" class="btn-primary w-full text-white font-bold py-3 rounded-lg mt-8 flex items-center justify-center gap-2">
            <span>Değişiklikleri Onayla</span>
            <span class="flex items-center">(100 <span class="text-blue-400 ml-1">💎</span>)</span>
        </button>
    </div>
</div>
            <!-- Other Game Sub-screens -->
            <div id="garage-screen" class="game-sub-screen hidden w-full h-full">
                <h1 class="text-4xl font-bold">Garaj</h1>
                <p>Mevcut Araç: El Arabası</p>
                <button class="nav-arrow back-to-home-button" style="left: 5%; top: 50%; transform: translateY(-50%);" title="Eve Geri Dön">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
            </div>
            <div id="garden-screen" class="game-sub-screen hidden w-full h-full">
                <h1 class="text-4xl font-bold">Bahçe</h1>
                <div class="flex gap-4 mt-4">
                    <p>Boks Torbası</p> <p>Yoga Matı</p> <p>Atlama İpi</p> <p>Zeka Küpü</p>
                </div>
                <button class="nav-arrow back-to-home-button" style="right: 5%; top: 50%; transform: translateY(-50%);" title="Eve Geri Dön">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
             <div id="basement-screen" class="game-sub-screen hidden w-full h-full p-8">
                <button class="nav-arrow back-to-home-button" style="top: 5%; left: 50%; transform: translateX(-50%);" title="Eve Geri Dön">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                </button>
                <h1 class="text-4xl font-bold absolute" style="top: 18%;">Mahzen</h1>

                 <div class="text-center">
                     <p class="text-xl text-gray-300 mb-2">Üretim Durumu</p>
                     <p class="text-3xl font-bold text-yellow-400">Boşta</p>
                     <button class="btn-primary py-3 px-6 rounded-lg mt-8 text-lg">Üretime Başla</button>
                 </div>
                 <!-- Hammer Icon Button -->
                 <button id="open-basement-menu" class="absolute top-8 right-8 nav-arrow w-16 h-16">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                 </button>
            </div>
            <div id="arena-screen" class="game-sub-screen hidden w-full h-full relative">
                <div id="arena-main-view" class="flex flex-col items-center justify-center w-full h-full">
                     <button class="nav-arrow back-to-village-button" style="top: 5%; left: 50%; transform: translateX(-50%);" title="Köy'e Geri Dön">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                    </button>
                    <h1 class="text-4xl font-bold mb-8">Arena</h1>
                    <div class="flex gap-8">
                        <button id="show-leagues-button" class="btn-primary p-8 rounded-lg">Ligler</button>
                        <button id="show-dungeons-button" class="btn-primary p-8 rounded-lg">Zindanlar</button>
                    </div>
                </div>
                 <div id="leagues-screen" class="hidden text-center">
                    <button class="nav-arrow back-to-arena-button" style="position: absolute; top: 5%; left: 50%; transform: translateX(-50%);" title="Arenaya Geri Dön">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                    </button>
                    <h2 class="text-3xl">Ligler</h2><p>Yakında...</p>
                </div>
                 <div id="dungeons-screen" class="hidden text-center">
                    <button class="nav-arrow back-to-arena-button" style="position: absolute; top: 5%; left: 50%; transform: translateX(-50%);" title="Arenaya Geri Dön">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                    </button>
                    <h2 class="text-3xl">Zindanlar</h2><p>Yakında...</p>
                </div>
            </div>
            <div id="market-screen" class="game-sub-screen hidden w-full h-full relative">
                 <div id="market-main-view" class="flex flex-col items-center justify-center w-full h-full">
                     <button class="nav-arrow back-to-village-button" style="top: 5%; left: 50%; transform: translateX(-50%);" title="Köy'e Geri Dön">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                    </button>
                    <h1 class="text-4xl font-bold mb-8">Market</h1>
                    <div class="flex gap-8">
                        <button id="show-market-buy-button" class="btn-primary p-8 rounded-lg">Pazar</button>
                        <button id="show-market-sell-button" class="btn-primary p-8 rounded-lg">Borsa</button>
                        <button id="show-market-trade-button" class="btn-primary p-8 rounded-lg">Market</button>
                    </div>
                </div>
                 <div id="market-buy-screen" class="hidden text-center">
                    <button class="nav-arrow back-to-market-button" style="position: absolute; top: 5%; left: 50%; transform: translateX(-50%);" title="Markete Geri Dön">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                    </button>
                    <h2 class="text-3xl">Satın Al</h2><p>Yakında...</p>
                </div>
                <div id="market-sell-screen" class="hidden w-full max-w-4xl p-4">
                     <button class="nav-arrow back-to-market-button" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%);" title="Markete Geri Dön">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                    </button>
                    <h2 class="text-3xl text-center mb-4 mt-16">İçki Borsası</h2>
                    <div class="w-full h-64 bg-gray-900/50 p-2 rounded-lg border border-gray-700 mb-4">
                        <canvas id="price-chart"></canvas>
                    </div>
                    <div class="space-y-2 text-lg">
                        <div class="flex justify-between items-center bg-gray-800/60 p-2 rounded-md">
                            <span>Elma Şarabı (x10)</span>
                            <div class="flex items-center gap-4">
                                <span id="apple-wine-price" class="font-bold text-yellow-400">120 💰</span>
                                <button class="btn-primary px-4 py-1 rounded">Sat</button>
                            </div>
                        </div>
                         <div class="flex justify-between items-center bg-gray-800/60 p-2 rounded-md">
                            <span>Üzüm Şarabı (x5)</span>
                            <div class="flex items-center gap-4">
                                <span id="grape-wine-price" class="font-bold text-yellow-400">250 💰</span>
                                <button class="btn-primary px-4 py-1 rounded">Sat</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- MARKET TRADE SCREEN - START -->
                <div id="market-trade-screen" class="hidden w-full h-full max-w-6xl p-4 flex flex-col">
                    <button class="nav-arrow back-to-market-button" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%);" title="Markete Geri Dön">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                    </button>
                    <h2 class="text-3xl text-center font-bold mb-4 mt-16">Tüccar</h2>
                    <div id="market-category-tabs" class="flex justify-center gap-2 mb-4 p-1 bg-gray-900/50 rounded-lg border border-gray-700">
                        <!-- Category buttons will be generated here -->
                    </div>
                    <div id="market-subcategory-tabs" class="hidden flex-wrap justify-center gap-2 mb-4 p-1 bg-gray-800/30 rounded-lg">
                        </div>
                    <div id="market-item-list" class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4 bg-gray-900/50 rounded-lg border border-gray-700">
                        <!-- Item listings will be generated here -->
                    </div>
                </div>
                <!-- MARKET TRADE SCREEN - END -->
                <div id="market-quick-sell-screen" class="hidden w-full h-full max-w-6xl p-4 flex flex-col">
                    <button class="nav-arrow back-to-market-button" style="position: absolute; top: 20px; left: 50%; transform: translateX(-50%);" title="Markete Geri Dön">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                    </button>
                    <h2 class="text-3xl text-center font-bold mb-4 mt-16">Hızlı Sat</h2>
                    <div class="flex-grow flex gap-4">
                        <div id="quick-sell-inventory-grid" class="w-2/3 grid grid-cols-8 gap-2 p-4 bg-gray-900/50 rounded-lg border border-gray-700 overflow-y-auto">
                            </div>
                        <div class="w-1/3 p-4 bg-gray-900/50 rounded-lg border border-gray-700 flex flex-col">
                            <h3 class="text-xl font-bold mb-4">Satılacaklar</h3>
                            <div class="flex-grow text-gray-300">
                                <p>Satmak istediğin eşyalara tıkla.</p>
                            </div>
                            <div class="border-t border-gray-600 pt-4">
                                <p class="text-lg">Toplam Değer:</p>
                                <p id="quick-sell-total" class="text-3xl font-bold text-yellow-400 mb-4">0 💰</p>
                                <button id="quick-sell-confirm-button" class="btn-primary w-full text-white font-bold py-3 rounded-lg" disabled>Satışı Onayla</button>
                            </div>
                        </div>
                    </div>
                </div>


            </div>

            <!-- Basement Menu Screens -->
            <div id="basement-menu-screen" class="game-sub-screen hidden w-full h-full p-8 bg-black/50">
                 <div class="text-center flex flex-col sm:flex-row gap-8">
                     <button id="show-developments-button" class="btn-primary text-2xl font-bold py-12 px-16 rounded-2xl">Geliştirmeler</button>
                     <button id="show-employees-button" class="btn-primary text-2xl font-bold py-12 px-16 rounded-2xl">Elemanlar</button>
                 </div>
                 <button id="close-basement-menu" class="absolute top-4 right-4 text-gray-400 text-5xl leading-none hover:text-white transition">&times;</button>
            </div>
            <div id="developments-screen" class="game-sub-screen hidden w-full h-full p-8">
                <h2 class="text-3xl font-bold mb-6">Geliştirmeler</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-5xl">
                    <div class="upgrade-card rounded-lg p-4 flex flex-col">
                        <h3 class="text-xl font-bold text-blue-400">Bakır Damıtıcı (Seviye 1)</h3>
                        <p class="text-gray-300 my-2 flex-grow">İçkilerin saflığını artırır ve üretim süresini %10 kısaltır.</p>
                        <button class="btn-primary w-full mt-auto py-2 rounded-lg">Geliştir: 1000 💰</button>
                    </div>
                    <div class="upgrade-card rounded-lg p-4 flex flex-col">
                        <h3 class="text-xl font-bold text-blue-400">Meşe Fıçılar (Seviye 0)</h3>
                        <p class="text-gray-300 my-2 flex-grow">Nadir içkiler üretme şansı verir ve içki kalitesini artırır.</p>
                        <button class="btn-primary w-full mt-auto py-2 rounded-lg">Satın Al: 2500 💰</button>
                    </div>
                     <div class="upgrade-card rounded-lg p-4 flex flex-col">
                        <h3 class="text-xl font-bold text-blue-400">Genişletilmiş Depo (Seviye 0)</h3>
                        <p class="text-gray-300 my-2 flex-grow">Aynı anda daha fazla içki depolamanı sağlar.</p>
                        <button class="btn-primary w-full mt-auto py-2 rounded-lg">Satın Al: 1500 💰</button>
                    </div>
                </div>
                <button class="back-to-basement-menu btn-primary py-2 px-4 rounded-lg mt-8">Geri</button>
            </div>
            <div id="employees-screen" class="game-sub-screen hidden w-full h-full p-8">
                 <h2 class="text-3xl font-bold mb-6">Elemanlar</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-5xl">
                    <div class="upgrade-card rounded-lg p-4 flex flex-col text-center">
                        <span class="text-5xl">👨‍🌾</span>
                        <h3 class="text-xl font-bold text-green-400 mt-2">Çırak</h3>
                        <p class="text-gray-300 my-2 flex-grow">Üretimden pasif olarak gelir sağlar.</p>
                        <p class="font-semibold text-lg">+10 💰 / saat</p>
                        <button class="btn-primary w-full mt-auto py-2 rounded-lg">İşe Al</button>
                    </div>
                    <div class="upgrade-card rounded-lg p-4 flex flex-col text-center">
                        <span class="text-5xl">🧪</span>
                        <h3 class="text-xl font-bold text-green-400 mt-2">Simyacı</h3>
                        <p class="text-gray-300 my-2 flex-grow">Nadir içki üretme şansını artırır.</p>
                        <p class="font-semibold text-lg">Maaş: 100 💰 / saat</p>
                        <button class="btn-primary w-full mt-auto py-2 rounded-lg" disabled>Gerekli Geliştirme: Meşe Fıçılar</button>
                    </div>
                 </div>
                <button class="back-to-basement-menu btn-primary py-2 px-4 rounded-lg mt-8">Geri</button>
            </div>

            <!-- Game UI Overlay -->
            <div id="game-ui-overlay" class="absolute inset-0 pointer-events-none">
                <button id="player-profile-button" class="absolute top-4 left-4 w-[15%] max-w-[180px] aspect-square p-2 form-container rounded-xl shadow-lg cursor-pointer hover:border-blue-500 transition pointer-events-auto">
                     <svg id="profile-character-preview" viewBox="0 0 200 300" class="w-full h-full"></svg>
                </button>
                <div class="absolute bottom-24 left-1/2 -translate-x-1/2 pointer-events-auto" id="energy-bar-container">
                    <div id="energy-bar-fill" style="width: 100%;"><span id="energy-bar-text">⚡ 100/100</span></div>
                </div>
                <div id="hotbar-inventory" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-2 p-2 form-container rounded-xl pointer-events-auto">
                    <div class="inventory-slot w-16 h-16 rounded-lg"></div> <div class="inventory-slot w-16 h-16 rounded-lg"></div> <div class="inventory-slot w-16 h-16 rounded-lg"></div> <div class="inventory-slot w-16 h-16 rounded-lg"></div> <div class="inventory-slot w-16 h-16 rounded-lg"></div>
                </div>
            </div>
        </div>
    </div>
    <!-- GLOBAL UI & MODALS -->
    <div id="global-ui" class="hidden">
        <div class="absolute top-4 right-4 form-container rounded-lg p-2 flex items-center space-x-4">
            <div class="flex items-center space-x-2 has-tooltip relative">
                <span class="text-yellow-400">💰</span>
                <span id="gold-display" class="font-bold">0</span>
                <div id="gold-tooltip" class="tooltip absolute top-full mt-2 -right-2 bg-gray-800 text-white text-xs rounded py-1 px-2 shadow-lg">0</div>
            </div>
            <div class="flex items-center space-x-2 has-tooltip relative">
                <span class="text-blue-400">💎</span>
                <span id="diamond-display" class="font-bold">0</span>
                <div id="diamond-tooltip" class="tooltip absolute top-full mt-2 -right-2 bg-gray-800 text-white text-xs rounded py-1 px-2 shadow-lg">0</div>
            </div>
        </div>
        <button id="global-settings-button" class="absolute bottom-4 right-4 text-white hover:text-blue-400 transition">
            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2.15l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1 0-2.15l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
    </div>
    <div id="settings-modal" class="hidden absolute inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="form-container rounded-2xl p-8 shadow-2xl w-full max-w-md">
           <h2 class="text-3xl font-bold text-center mb-8">Ayarlar</h2>
           <div class="space-y-6">
               <div class="flex items-center justify-between"><label for="volume-slider" class="font-semibold text-lg">Ses Seviyesi</label><input id="volume-slider" type="range" min="0" max="100" value="80" class="w-1/2"></div>
                <div class="space-y-2">
                    <label for="gift-code-input" class="font-semibold text-lg">Hediye Kodu</label>
                    <div class="flex gap-2">
                        <input id="gift-code-input" type="text" placeholder="Kodu buraya girin..." class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="redeem-code-button" class="btn-primary px-4 rounded-lg">Kullan</button>
                    </div>
                    <p id="gift-code-message" class="text-sm h-4"></p>
                </div>
               <button id="logout-button" class="w-full bg-red-600 hover:bg-red-500 transition font-bold py-3 rounded-lg">Oturumu Kapat</button>
           </div>
           <button id="close-settings-modal" class="bg-gray-700 hover:bg-gray-600 transition w-full text-white font-bold py-3 rounded-lg mt-10">Kapat</button>
        </div>
    </div>
    <div id="character-sheet-modal" class="hidden absolute inset-0 bg-black/60 flex items-center justify-center p-4 character-sheet-modal modal-closed z-40">
        <div class="character-sheet-window w-full max-w-4xl form-container rounded-2xl shadow-2xl relative p-6">
            <button id="close-character-sheet-button" class="absolute top-4 right-4 text-gray-400 text-3xl leading-none hover:text-white transition">&times;</button>
            <div class="flex gap-6">
                <div class="w-1/3 flex flex-col items-center gap-4">
    <div class="w-full text-center">
        <h2 id="sheet-player-name" class="text-2xl font-bold">Oyuncu Adı</h2>
        <p id="sheet-player-level" class="text-blue-400">Seviye 1</p>
    </div>

    <div id="equipment-paper-doll" class="w-full grid grid-cols-3 grid-rows-5 gap-2">
        <div id="equip-slot-helmet" data-slot-type="Kask" class="inventory-slot equipment-slot"></div>
        <div id="equip-slot-necklace" data-slot-type="Kolye" class="inventory-slot equipment-slot"></div>
        <div id="equip-slot-earring" data-slot-type="Küpe" class="inventory-slot equipment-slot"></div>

        <div id="equip-slot-weapon" data-slot-type="Silah" class="inventory-slot equipment-slot row-span-2"></div>
        <div class="w-full h-full row-span-3 bg-gray-900/50 rounded-xl border border-gray-700">
            <svg id="sheet-character-preview" viewBox="0 0 200 300" class="w-full h-full"></svg>
        </div>
        <div id="equip-slot-chest" data-slot-type="Göğüslük" class="inventory-slot equipment-slot"></div>
        
        <div></div> <div id="equip-slot-gloves" data-slot-type="Eldiven" class="inventory-slot equipment-slot"></div>

        <div id="equip-slot-belt" data-slot-type="Kemer" class="inventory-slot equipment-slot"></div>
        <div></div> <div id="equip-slot-bracelet" data-slot-type="Bilezik" class="inventory-slot equipment-slot"></div>

        <div id="equip-slot-pants" data-slot-type="Pantolon" class="inventory-slot equipment-slot"></div>
        <div id="equip-slot-boots" data-slot-type="Ayakkabı" class="inventory-slot equipment-slot"></div>
        <div></div> </div>

    <div id="derived-stats-display" class="w-full p-3 bg-gray-900/50 rounded-lg space-y-2 text-sm"></div>
</div>
                <div class="w-2/3">
                    <div class="space-y-3 mb-6">
                         <div class="flex items-center gap-2">
                            <span class="font-semibold text-lg">EXP</span>
                            <div class="w-full bg-gray-900/50 rounded-full h-5 border border-gray-700">
                                <div id="sheet-exp-bar" class="exp-bar-fill h-full rounded-full text-xs flex items-center justify-center" style="width: 0%;">
                                    <span id="sheet-exp-text">0 / 100</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <details id="stats-details-panel" class="mb-6">
                        <summary class="text-xl font-bold border-b border-gray-700 pb-2 cursor-pointer">
                            Nitelikler (<span id="sheet-stat-points">0</span> Puan)
                        </summary>
                        <div id="stats-container" class="space-y-3 pt-4"></div>
                    </details>
                    <div>
                        <h3 class="text-xl font-bold mb-3 border-b border-gray-700 pb-2">Envanter</h3>
                        <div id="character-inventory-grid" class="grid grid-cols-6 gap-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- CHEST MODAL START -->
    <div id="chest-modal" class="hidden absolute inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div id="chest-container" class="form-container rounded-2xl p-6 shadow-2xl relative w-full max-w-5xl flex flex-col sm:flex-row gap-6">
            <!-- Close Button -->
            <button id="close-chest-button" class="absolute top-4 right-4 text-gray-400 text-3xl leading-none hover:text-white transition">&times;</button>
            
            <!-- Player Inventory -->
            <div class="w-full sm:w-1/2">
                <h3 class="text-xl font-bold mb-3 text-center">Envanterin</h3>
                <div id="chest-player-inventory" class="grid grid-cols-6 gap-2 bg-gray-900/50 p-2 rounded-lg border border-gray-700 h-[320px] sm:h-auto overflow-y-auto">
                    <!-- 5x6 slots will be generated by JS -->
                </div>
            </div>

            <!-- House Inventory -->
            <div class="w-full sm:w-1/2">
                <div class="flex justify-center items-center mb-3 gap-4">
                    <h3 class="text-xl font-bold">Ev Deposu</h3>
                    <div class="flex gap-1 p-1 bg-gray-900/50 rounded-lg border border-gray-700">
                        <button id="chest-page-1" data-page="1" class="chest-page-btn px-3 py-1 rounded font-bold">1</button>
                        <button id="chest-page-2" data-page="2" class="chest-page-btn px-3 py-1 rounded font-bold">2</button>
                    </div>
                </div>
                <div id="chest-house-inventory" class="grid grid-cols-6 gap-2 bg-gray-900/50 p-2 rounded-lg border border-gray-700 h-[320px] sm:h-auto overflow-y-auto">
                     <!-- 5x6 slots for the current page will be generated by JS -->
                </div>
            </div>
        </div>
    </div>
    <!-- CHEST MODAL END -->

    <div id="stat-tooltip" class="hidden absolute w-64 p-3 form-container rounded-lg shadow-xl text-sm z-50 opacity-0"></div>

    <div id="item-tooltip" class="hidden absolute w-72 p-3 form-container rounded-lg shadow-xl text-sm z-[9999] opacity-0"></div>

    <div id="quick-sell-confirmation-modal" class="hidden absolute inset-0 bg-black/70 flex items-center justify-center z-[100]">
        <div class="form-container rounded-2xl p-8 shadow-2xl w-full max-w-md text-center">
            <h2 class="text-2xl font-bold mb-4">Satışı Onayla</h2>
            <p class="text-gray-300 mb-6">Seçili eşyaları <strong id="confirm-sell-price" class="text-yellow-400">0 💰</strong> karşılığında satmak istediğine emin misin? Bu işlem geri alınamaz.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-sell-yes-btn" class="bg-red-600 hover:bg-red-500 font-bold py-3 px-8 rounded-lg transition">Evet, Sat</button>
                <button id="confirm-sell-no-btn" class="bg-gray-600 hover:bg-gray-500 font-bold py-3 px-8 rounded-lg transition">İptal</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, runTransaction, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDvChKu2Fv7r1l0faDLof9Yhae4kodiDGo",
            authDomain: "mustea-gangster.firebaseapp.com",
            projectId: "mustea-gangster",
            storageBucket: "mustea-gangster.appspot.com",
            messagingSenderId: "546211784548",
            appId: "1:546211784548:web:f4bab064b1941bc4067c71"
        };

        const RARITY_CONFIG = {
            common: { name: 'Yaygın', color: '#9ca3af', priceMultiplier: 1 },
            uncommon: { name: 'Sıradışı', color: '#22c55e', priceMultiplier: 1.5 },
            rare: { name: 'Nadir', color: '#3b82f6', priceMultiplier: 2.5 },
            epic: { name: 'Epik', color: '#a855f7', priceMultiplier: 5 },
            legendary: { name: 'Efsanevi', color: '#f97316', priceMultiplier: 10 }
        };

        // GÜNCELLENMİŞ EŞYA LİSTESİ
        
        const GAME_ITEMS = {
    // =================================================================================
    // SİLAHLAR
    // =================================================================================
    // -- Kısa Kılıç
    'shortsword_1': { name: "Paslı Kısa Kılıç", category: 'Silah', subCategory: 'Kısa kılıç', baseRarity: 'common', requiredLevel: 1, stats: { damage: 6 }, buyPrice: 60, sellPrice: 30, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-700"><path d="M14.5 17.5 3 6V3h3l11.5 11.5"/><path d="m21 15-6-6"/><path d="M3.5 17.5 9 12"/><path d="M15 3.5 12 9"/></svg>' },
    'shortsword_2': { name: "Demir Kısa Kılıç", category: 'Silah', subCategory: 'Kısa kılıç', baseRarity: 'common', requiredLevel: 5, stats: { damage: 11 }, buyPrice: 150, sellPrice: 75, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-400"><path d="M14.5 17.5 3 6V3h3l11.5 11.5"/><path d="m21 15-6-6"/><path d="M3.5 17.5 9 12"/><path d="M15 3.5 12 9"/></svg>' },
    'shortsword_3': { name: "Çelik Kısa Kılıç", category: 'Silah', subCategory: 'Kısa kılıç', baseRarity: 'rare', requiredLevel: 12, stats: { damage: 18, speed: 2 }, buyPrice: 500, sellPrice: 250, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-300"><path d="M14.5 17.5 3 6V3h3l11.5 11.5"/><path d="m21 15-6-6"/><path d="M3.5 17.5 9 12"/><path d="M15 3.5 12 9"/></svg>' },
    'shortsword_4': { name: "Elf İşi Kısa Kılıç", category: 'Silah', subCategory: 'Kısa kılıç', baseRarity: 'rare', requiredLevel: 18, stats: { damage: 25, dodge: 3 }, buyPrice: 0, sellPrice: 450, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-400"><path d="M14.5 17.5 3 6V3h3l11.5 11.5"/><path d="m21 15-6-6"/><path d="M3.5 17.5 9 12"/><path d="M15 3.5 12 9"/></svg>' },
    'shortsword_5': { name: "Obsidyen Kama", category: 'Silah', subCategory: 'Kısa kılıç', baseRarity: 'epic', requiredLevel: 25, stats: { damage: 35, damageReduction: 1 }, buyPrice: 0, sellPrice: 900, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-purple-400"><path d="M14.5 17.5 3 6V3h3l11.5 11.5"/><path d="m21 15-6-6"/><path d="M3.5 17.5 9 12"/><path d="M15 3.5 12 9"/></svg>' },
    
    // -- Uzun Kılıç
    'longsword_1': { name: "Acemi Uzun Kılıcı", category: 'Silah', subCategory: 'Uzun kılıç', baseRarity: 'common', requiredLevel: 3, stats: { damage: 9 }, buyPrice: 100, sellPrice: 50, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-300"><path d="M21.7 18.3c.4-.4.4-1 0-1.4l-3-3-1.4 1.4 3 3c.4.4 1 .4 1.4 0z"/><path d="m16 5-4 4-3 3-4 4 1.4 1.4 4-4 3-3 4-4z"/><path d="M10 6 5 11l-4 4 1.4 1.4 4-4 5-5z"/><path d="M2 22l4-4"/><path d="m18 12 4-4"/></svg>' },
    'longsword_2': { name: "Şövalye Kılıcı", category: 'Silah', subCategory: 'Uzun kılıç', baseRarity: 'common', requiredLevel: 8, stats: { damage: 15, hp: 10 }, buyPrice: 280, sellPrice: 140, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-500"><path d="M21.7 18.3c.4-.4.4-1 0-1.4l-3-3-1.4 1.4 3 3c.4.4 1 .4 1.4 0z"/><path d="m16 5-4 4-3 3-4 4 1.4 1.4 4-4 3-3 4-4z"/><path d="M10 6 5 11l-4 4 1.4 1.4 4-4 5-5z"/><path d="M2 22l4-4"/><path d="m18 12 4-4"/></svg>' },
    'longsword_3': { name: "Gümüş Uzun Kılıç", category: 'Silah', subCategory: 'Uzun kılıç', baseRarity: 'rare', requiredLevel: 15, stats: { damage: 24 }, buyPrice: 700, sellPrice: 350, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-200"><path d="M21.7 18.3c.4-.4.4-1 0-1.4l-3-3-1.4 1.4 3 3c.4.4 1 .4 1.4 0z"/><path d="m16 5-4 4-3 3-4 4 1.4 1.4 4-4 3-3 4-4z"/><path d="M10 6 5 11l-4 4 1.4 1.4 4-4 5-5z"/><path d="M2 22l4-4"/><path d="m18 12 4-4"/></svg>' },
    'longsword_4': { name: "Alevli Uzun Kılıç", category: 'Silah', subCategory: 'Uzun kılıç', baseRarity: 'epic', requiredLevel: 22, stats: { damage: 33 }, buyPrice: 0, sellPrice: 1200, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-orange-500"><path d="M21.7 18.3c.4-.4.4-1 0-1.4l-3-3-1.4 1.4 3 3c.4.4 1 .4 1.4 0z"/><path d="m16 5-4 4-3 3-4 4 1.4 1.4 4-4 3-3 4-4z"/><path d="M10 6 5 11l-4 4 1.4 1.4 4-4 5-5z"/><path d="M2 22l4-4"/><path d="m18 12 4-4"/></svg>' },
    'longsword_5': { name: "Ejder Kemiği Kılıcı", category: 'Silah', subCategory: 'Uzun kılıç', baseRarity: 'legendary', requiredLevel: 30, stats: { damage: 45, hp: 50 }, buyPrice: 0, sellPrice: 2500, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-red-500"><path d="M21.7 18.3c.4-.4.4-1 0-1.4l-3-3-1.4 1.4 3 3c.4.4 1 .4 1.4 0z"/><path d="m16 5-4 4-3 3-4 4 1.4 1.4 4-4 3-3 4-4z"/><path d="M10 6 5 11l-4 4 1.4 1.4 4-4 5-5z"/><path d="M2 22l4-4"/><path d="m18 12 4-4"/></svg>' },

    // -- Hançer
    'dagger_1': { name: "Demir Hançer", category: 'Silah', subCategory: 'Hançer', baseRarity: 'common', requiredLevel: 2, stats: { damage: 7, speed: 3 }, buyPrice: 120, sellPrice: 60, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-400"><path d="m2.6 15.6 3.4-3.4c.2-.2.5-.3.8-.3H10l6-6-4.5-4.5-6 6v3.2c0 .3-.1.6-.3.8L2.6 15.6a3 3 0 0 0 0 4.2l.6.6a3 3 0 0 0 4.2 0l-4.8-4.8Z"/></svg>' },
    'dagger_2': { name: "Suikastçi Hançeri", category: 'Silah', subCategory: 'Hançer', baseRarity: 'common', requiredLevel: 7, stats: { damage: 12, speed: 5 }, buyPrice: 250, sellPrice: 125, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-600"><path d="m2.6 15.6 3.4-3.4c.2-.2.5-.3.8-.3H10l6-6-4.5-4.5-6 6v3.2c0 .3-.1.6-.3.8L2.6 15.6a3 3 0 0 0 0 4.2l.6.6a3 3 0 0 0 4.2 0l-4.8-4.8Z"/></svg>' },
    'dagger_3': { name: "Zehirli Hançer", category: 'Silah', subCategory: 'Hançer', baseRarity: 'rare', requiredLevel: 14, stats: { damage: 20, speed: 4 }, buyPrice: 680, sellPrice: 340, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-lime-500"><path d="m2.6 15.6 3.4-3.4c.2-.2.5-.3.8-.3H10l6-6-4.5-4.5-6 6v3.2c0 .3-.1.6-.3.8L2.6 15.6a3 3 0 0 0 0 4.2l.6.6a3 3 0 0 0 4.2 0l-4.8-4.8Z"/></svg>' },
    'dagger_4': { name: "Ruh Kesiği", category: 'Silah', subCategory: 'Hançer', baseRarity: 'epic', requiredLevel: 21, stats: { damage: 28, speed: 6, mana: 20 }, buyPrice: 0, sellPrice: 1150, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-indigo-400"><path d="m2.6 15.6 3.4-3.4c.2-.2.5-.3.8-.3H10l6-6-4.5-4.5-6 6v3.2c0 .3-.1.6-.3.8L2.6 15.6a3 3 0 0 0 0 4.2l.6.6a3 3 0 0 0 4.2 0l-4.8-4.8Z"/></svg>' },
    'dagger_5': { name: "Gölgelerin Dişi", category: 'Silah', subCategory: 'Hançer', baseRarity: 'epic', requiredLevel: 28, stats: { damage: 38, dodge: 5 }, buyPrice: 0, sellPrice: 2300, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-violet-500"><path d="m2.6 15.6 3.4-3.4c.2-.2.5-.3.8-.3H10l6-6-4.5-4.5-6 6v3.2c0 .3-.1.6-.3.8L2.6 15.6a3 3 0 0 0 0 4.2l.6.6a3 3 0 0 0 4.2 0l-4.8-4.8Z"/></svg>' },

    // -- Balta
    'axe_1': { name: "Oduncu Baltası", category: 'Silah', subCategory: 'Balta', baseRarity: 'common', requiredLevel: 4, stats: { damage: 12 }, buyPrice: 110, sellPrice: 55, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-700"><path d="m14 12-8.5 8.5a2.12 2.12 0 1 1-3-3L11 9"/><path d="M15 13 9 7l4-4 6 6h3l-3 3z"/></svg>' },
    'axe_2': { name: "Savaş Baltası", category: 'Silah', subCategory: 'Balta', baseRarity: 'common', requiredLevel: 9, stats: { damage: 19, hp: 15 }, buyPrice: 320, sellPrice: 160, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-500"><path d="m14 12-8.5 8.5a2.12 2.12 0 1 1-3-3L11 9"/><path d="M15 13 9 7l4-4 6 6h3l-3 3z"/></svg>' },
    'axe_3': { name: "Cüce Baltası", category: 'Silah', subCategory: 'Balta', baseRarity: 'rare', requiredLevel: 16, stats: { damage: 28, damageReduction: 1 }, buyPrice: 750, sellPrice: 375, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-400"><path d="m14 12-8.5 8.5a2.12 2.12 0 1 1-3-3L11 9"/><path d="M15 13 9 7l4-4 6 6h3l-3 3z"/></svg>' },
    'axe_4': { name: "Cellat Baltası", category: 'Silah', subCategory: 'Balta', baseRarity: 'rare', requiredLevel: 24, stats: { damage: 38 }, buyPrice: 0, sellPrice: 1300, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-red-600"><path d="m14 12-8.5 8.5a2.12 2.12 0 1 1-3-3L11 9"/><path d="M15 13 9 7l4-4 6 6h3l-3 3z"/></svg>' },
    'axe_5': { name: "Gök Gürültüsü", category: 'Silah', subCategory: 'Balta', baseRarity: 'legendary', requiredLevel: 32, stats: { damage: 50, hp: 100 }, buyPrice: 0, sellPrice: 3000, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-400"><path d="m14 12-8.5 8.5a2.12 2.12 0 1 1-3-3L11 9"/><path d="M15 13 9 7l4-4 6 6h3l-3 3z"/></svg>' },

    // -- Topuz
    'mace_1': { name: "Ahşap Topuz", category: 'Silah', subCategory: 'Topuz', baseRarity: 'common', requiredLevel: 3, stats: { damage: 10 }, buyPrice: 90, sellPrice: 45, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-700"><path d="M14 22V8a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h4"/><path d="M14 14h6a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v1.5"/></svg>' },
    'mace_2': { name: "Demir Dikenli Topuz", category: 'Silah', subCategory: 'Topuz', baseRarity: 'common', requiredLevel: 8, stats: { damage: 17 }, buyPrice: 290, sellPrice: 145, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-500"><path d="M14 22V8a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h4"/><path d="M14 14h6a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v1.5"/></svg>' },
    'mace_3': { name: "Rahip Topuzu", category: 'Silah', subCategory: 'Topuz', baseRarity: 'rare', requiredLevel: 15, stats: { damage: 25, mana: 25 }, buyPrice: 720, sellPrice: 360, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-200"><path d="M14 22V8a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h4"/><path d="M14 14h6a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v1.5"/></svg>' },
    'mace_4': { name: "Kemik Kıran", category: 'Silah', subCategory: 'Topuz', baseRarity: 'epic', requiredLevel: 23, stats: { damage: 36, damageReduction: 2 }, buyPrice: 0, sellPrice: 1250, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-red-700"><path d="M14 22V8a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h4"/><path d="M14 14h6a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v1.5"/></svg>' },
    'mace_5': { name: "Deprem", category: 'Silah', subCategory: 'Topuz', baseRarity: 'epic', requiredLevel: 29, stats: { damage: 44, hp: 80 }, buyPrice: 0, sellPrice: 2400, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-orange-600"><path d="M14 22V8a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v2a2 2 0 0 0 2 2h4"/><path d="M14 14h6a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v1.5"/></svg>' },

    // -- Menzilliler
    'ranged_1': { name: "Sapan", category: 'Silah', subCategory: 'Menzilliler', baseRarity: 'common', requiredLevel: 2, stats: { damage: 8, speed: 4 }, buyPrice: 70, sellPrice: 35, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-700"><path d="M7 20.32c-.8.88-1.55.43-1.68-.62.22-1.8 1.4-3.32 3.53-4.44.8-.42 1.68-.42 2.48 0 2.13 1.12 3.3 2.64 3.53 4.44.13 1.05-.88 1.5-1.68.62L12 18.88l-1.15 1.44z"/><path d="M19.33 11.67A2.12 2.12 0 0 0 19.33 8.5L12 .67 4.67 8.5a2.12 2.12 0 0 0 0 3.17l.79.83.66.66L12 7.17l5.88 5.89.66-.67.79-.82z"/></svg>' },
    'ranged_2': { name: "Kısa Yay", category: 'Silah', subCategory: 'Menzilliler', baseRarity: 'common', requiredLevel: 6, stats: { damage: 13, speed: 6 }, buyPrice: 220, sellPrice: 110, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-800"><path d="M3 21c3 0 7-1 7-8-1 .7-2.2.9-3.4.7-1.4-.2-2.6-.9-3.6-1.7C2 11 2 9.3 2 8c0-4 4-6 6-6s6 2 6 6"/><path d="M2 8h20"/></svg>' },
    'ranged_3': { name: "Arbalet", category: 'Silah', subCategory: 'Menzilliler', baseRarity: 'rare', requiredLevel: 13, stats: { damage: 26, speed: -2 }, buyPrice: 650, sellPrice: 325, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-400"><path d="M3 21c3 0 7-1 7-8-1 .7-2.2.9-3.4.7-1.4-.2-2.6-.9-3.6-1.7C2 11 2 9.3 2 8c0-4 4-6 6-6s6 2 6 6"/><path d="M2 8h20"/><path d="M21 4h-4"/><path d="M21 8h-4"/><path d="M21 12h-4"/></svg>' },
    'ranged_4': { name: "Elf Yayı", category: 'Silah', subCategory: 'Menzilliler', baseRarity: 'rare', requiredLevel: 20, stats: { damage: 30, speed: 8, dodge: 2 }, buyPrice: 0, sellPrice: 1100, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-400"><path d="M3 21c3 0 7-1 7-8-1 .7-2.2.9-3.4.7-1.4-.2-2.6-.9-3.6-1.7C2 11 2 9.3 2 8c0-4 4-6 6-6s6 2 6 6"/><path d="M2 8h20"/><path d="M21 4h-4"/><path d="M21 8h-4"/><path d="M21 12h-4"/></svg>' },
    'ranged_5': { name: "Rüzgar Kesen", category: 'Silah', subCategory: 'Menzilliler', baseRarity: 'legendary', requiredLevel: 28, stats: { damage: 42, speed: 12 }, buyPrice: 0, sellPrice: 2800, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-cyan-300"><path d="M3 21c3 0 7-1 7-8-1 .7-2.2.9-3.4.7-1.4-.2-2.6-.9-3.6-1.7C2 11 2 9.3 2 8c0-4 4-6 6-6s6 2 6 6"/><path d="M2 8h20"/><path d="M21 4h-4"/><path d="M21 8h-4"/><path d="M21 12h-4"/></svg>' },

    // -- Asa
    'staff_1': { name: "Çırak Asası", category: 'Silah', subCategory: 'Asa', baseRarity: 'common', requiredLevel: 3, stats: { damage: 6, mana: 20 }, buyPrice: 130, sellPrice: 65, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-700"><path d="M21.44 11.05a.5.5 0 0 0 0-.5l-2-4A.5.5 0 0 0 18.95 6H5.06a.5.5 0 0 0-.49.55l2 4a.5.5 0 0 0 0 .5l-2 4a.5.5 0 0 0 .49.55h13.89a.5.5 0 0 0 .49-.55Z"/><path d="M3 22v-4"/><path d="M21 22v-4"/><path d="M12 18V2"/></svg>' },
    'staff_2': { name: "Büyücü Asası", category: 'Silah', subCategory: 'Asa', baseRarity: 'common', requiredLevel: 8, stats: { damage: 12, mana: 40 }, buyPrice: 350, sellPrice: 175, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-400"><path d="M21.44 11.05a.5.5 0 0 0 0-.5l-2-4A.5.5 0 0 0 18.95 6H5.06a.5.5 0 0 0-.49.55l2 4a.5.5 0 0 0 0 .5l-2 4a.5.5 0 0 0 .49.55h13.89a.5.5 0 0 0 .49-.55Z"/><path d="M3 22v-4"/><path d="M21 22v-4"/><path d="M12 18V2"/></svg>' },
    'staff_3': { name: "Yakut Asa", category: 'Silah', subCategory: 'Asa', baseRarity: 'rare', requiredLevel: 15, stats: { damage: 20, mana: 60, hp: 20 }, buyPrice: 800, sellPrice: 400, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-red-500"><path d="M21.44 11.05a.5.5 0 0 0 0-.5l-2-4A.5.5 0 0 0 18.95 6H5.06a.5.5 0 0 0-.49.55l2 4a.5.5 0 0 0 0 .5l-2 4a.5.5 0 0 0 .49.55h13.89a.5.5 0 0 0 .49-.55Z"/><path d="M3 22v-4"/><path d="M21 22v-4"/><path d="M12 18V2"/></svg>' },
    'staff_4': { name: "Bilge Asası", category: 'Silah', subCategory: 'Asa', baseRarity: 'epic', requiredLevel: 22, stats: { damage: 28, mana: 100 }, buyPrice: 0, sellPrice: 1500, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-400"><path d="M21.44 11.05a.5.5 0 0 0 0-.5l-2-4A.5.5 0 0 0 18.95 6H5.06a.5.5 0 0 0-.49.55l2 4a.5.5 0 0 0 0 .5l-2 4a.5.5 0 0 0 .49.55h13.89a.5.5 0 0 0 .49-.55Z"/><path d="M3 22v-4"/><path d="M21 22v-4"/><path d="M12 18V2"/></svg>' },
    'staff_5': { name: "Baş Büyücü Asası", category: 'Silah', subCategory: 'Asa', baseRarity: 'legendary', requiredLevel: 30, stats: { damage: 35, mana: 150, damageReduction: 2 }, buyPrice: 0, sellPrice: 3200, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-purple-400"><path d="M21.44 11.05a.5.5 0 0 0 0-.5l-2-4A.5.5 0 0 0 18.95 6H5.06a.5.5 0 0 0-.49.55l2 4a.5.5 0 0 0 0 .5l-2 4a.5.5 0 0 0 .49.55h13.89a.5.5 0 0 0 .49-.55Z"/><path d="M3 22v-4"/><path d="M21 22v-4"/><path d="M12 18V2"/></svg>' },

    // -- Büyü Kitabı
    'book_1': { name: "Acemi Büyü Kitabı", category: 'Silah', subCategory: 'Büyü kitabı', baseRarity: 'common', requiredLevel: 2, stats: { damage: 5, mana: 25 }, buyPrice: 150, sellPrice: 75, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-700"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>' },
    'book_2': { name: "Ateş Büyüleri Kitabı", category: 'Silah', subCategory: 'Büyü kitabı', baseRarity: 'common', requiredLevel: 7, stats: { damage: 14, mana: 35 }, buyPrice: 380, sellPrice: 190, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-red-500"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>' },
    'book_3': { name: "Buz Büyüleri Kitabı", category: 'Silah', subCategory: 'Büyü kitabı', baseRarity: 'rare', requiredLevel: 14, stats: { damage: 22, mana: 55 }, buyPrice: 780, sellPrice: 390, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-400"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>' },
    'book_4': { name: "Yasaklanmış Bilgiler", category: 'Silah', subCategory: 'Büyü kitabı', baseRarity: 'epic', requiredLevel: 23, stats: { damage: 34, mana: 80 }, buyPrice: 0, sellPrice: 1400, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-purple-500"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>' },
    'book_5': { name: "Necronomicon", category: 'Silah', subCategory: 'Büyü kitabı', baseRarity: 'legendary', requiredLevel: 35, stats: { damage: 48, mana: 120, hp: -50 }, buyPrice: 0, sellPrice: 3500, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-600"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>' },

    // =================================================================================
    // ZIRHLAR
    // =================================================================================
    // -- Kask
    'helmet_1': { name: "Deri Başlık", category: 'Zırh', subCategory: 'Kask', baseRarity: 'common', requiredLevel: 2, stats: { armor: 3 }, buyPrice: 40, sellPrice: 20, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-700"><path d="M12 2a4 4 0 0 0-4 4v2h8V6a4 4 0 0 0-4-4Z"/><path d="M18 12h-1.3a2 2 0 0 1-1.9-2.8l1.1-3.9a1 1 0 0 0-1-1.2h-4.8a1 1 0 0 0-1 1.2l1.1 3.8a2 2 0 0 1-2 2.8H6"/></svg>' },
    'helmet_2': { name: "Demir Miğfer", category: 'Zırh', subCategory: 'Kask', baseRarity: 'common', requiredLevel: 6, stats: { armor: 8, hp: 10 }, buyPrice: 150, sellPrice: 75, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-400"><path d="M12 2a4 4 0 0 0-4 4v2h8V6a4 4 0 0 0-4-4Z"/><path d="M18 12h-1.3a2 2 0 0 1-1.9-2.8l1.1-3.9a1 1 0 0 0-1-1.2h-4.8a1 1 0 0 0-1 1.2l1.1 3.8a2 2 0 0 1-2 2.8H6"/><path d="M12 22a4 4 0 0 0 4-4h-8a4 4 0 0 0 4 4Z"/></svg>' },
    'helmet_3': { name: "Çelik Miğfer", category: 'Zırh', subCategory: 'Kask', baseRarity: 'rare', requiredLevel: 10, stats: { armor: 12, damageReduction: 1 }, buyPrice: 450, sellPrice: 225, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-300"><path d="M12 2a4 4 0 0 0-4 4v2h8V6a4 4 0 0 0-4-4Z"/><path d="M18 12h-1.3a2 2 0 0 1-1.9-2.8l1.1-3.9a1 1 0 0 0-1-1.2h-4.8a1 1 0 0 0-1 1.2l1.1 3.8a2 2 0 0 1-2 2.8H6"/><path d="M12 22a4 4 0 0 0 4-4h-8a4 4 0 0 0 4 4Z"/></svg>' },
    'helmet_4': { name: "Büyücü Şapkası", category: 'Zırh', subCategory: 'Kask', baseRarity: 'rare', requiredLevel: 16, stats: { armor: 8, mana: 30 }, buyPrice: 0, sellPrice: 380, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-indigo-400"><path d="M12 2a4 4 0 0 0-4 4v2h8V6a4 4 0 0 0-4-4Z"/><path d="M18 12h-1.3a2 2 0 0 1-1.9-2.8l1.1-3.9a1 1 0 0 0-1-1.2h-4.8a1 1 0 0 0-1 1.2l1.1 3.8a2 2 0 0 1-2 2.8H6"/></svg>' },
    'helmet_5': { name: "Valkyrie Miğferi", category: 'Zırh', subCategory: 'Kask', baseRarity: 'legendary', requiredLevel: 28, stats: { armor: 20, hp: 50, damage: 5 }, buyPrice: 0, sellPrice: 2200, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-300"><path d="M12 2a4 4 0 0 0-4 4v2h8V6a4 4 0 0 0-4-4Z"/><path d="M18 12h-1.3a2 2 0 0 1-1.9-2.8l1.1-3.9a1 1 0 0 0-1-1.2h-4.8a1 1 0 0 0-1 1.2l1.1 3.8a2 2 0 0 1-2 2.8H6"/><path d="M12 22a4 4 0 0 0 4-4h-8a4 4 0 0 0 4 4Z"/></svg>' },

    // -- Göğüslük
    'chest_1': { name: "Kumaş Tunik", category: 'Zırh', subCategory: 'Göğüslük', baseRarity: 'common', requiredLevel: 1, stats: { armor: 4 }, buyPrice: 30, sellPrice: 15, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-300"><path d="M21 15a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>' },
    'chest_2': { name: "Demir Göğüslük", category: 'Zırh', subCategory: 'Göğüslük', baseRarity: 'common', requiredLevel: 7, stats: { armor: 15, hp: 30 }, buyPrice: 200, sellPrice: 100, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-500"><path d="M21 15a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M6 10V8a6 6 0 0 1 12 0v2"/></svg>' },
    'chest_3': { name: "Elf Zırhı", category: 'Zırh', subCategory: 'Göğüslük', baseRarity: 'rare', requiredLevel: 14, stats: { armor: 22, dodge: 5 }, buyPrice: 800, sellPrice: 400, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-400"><path d="m18.2 12 3.8-3L12 3 2 9l4 3-1.5 1.5L2 15l10 6 10-6-2.5-1.5Z"/><path d="M12 21V9"/><path d="m7.5 9.5-5.5 3"/><path d="m16.5 9.5 5.5 3"/></svg>' },
    'chest_4': { name: "Büyücü Cübbesi", category: 'Zırh', subCategory: 'Göğüslük', baseRarity: 'rare', requiredLevel: 18, stats: { armor: 15, mana: 60 }, buyPrice: 0, sellPrice: 750, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-purple-400"><path d="M21 15a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>' },
    'chest_5': { name: "Ejderha Pulu Zırhı", category: 'Zırh', subCategory: 'Göğüslük', baseRarity: 'legendary', requiredLevel: 32, stats: { armor: 40, hp: 100, damageReduction: 5 }, buyPrice: 0, sellPrice: 4000, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-orange-500"><path d="m2 14 4.1 4.1c.3.3.7.4 1.1.4h9.6c.4 0 .8-.1 1.1-.4L22 14"/><path d="m18 13-1.1-1.1a2 2 0 0 0-2.8 0L12 14l-2.1-2.1a2 2 0 0 0-2.8 0L6 13"/><path d="M15 3 9 9h6Z"/></svg>' },

    // -- Pantolon
    'pants_1': { name: "Kumaş Pantolon", category: 'Zırh', subCategory: 'Pantolon', baseRarity: 'common', requiredLevel: 1, stats: { armor: 2 }, buyPrice: 25, sellPrice: 12, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-300"><path d="M12 2v20"/><path d="M4 2v20"/><path d="M20 2v20"/><path d="M5 2h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1z"/></svg>' },
    'pants_2': { name: "Deri Pantolon", category: 'Zırh', subCategory: 'Pantolon', baseRarity: 'common', requiredLevel: 4, stats: { armor: 6 }, buyPrice: 80, sellPrice: 40, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-700"><path d="M12 2v20"/><path d="M4 2v20"/><path d="M20 2v20"/><path d="M5 2h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1z"/></svg>' },
    'pants_3': { name: "Zincir Zırh Pantolon", category: 'Zırh', subCategory: 'Pantolon', baseRarity: 'rare', requiredLevel: 9, stats: { armor: 11 }, buyPrice: 350, sellPrice: 175, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-500"><path d="M12 2v20"/><path d="M4 2v20"/><path d="M20 2v20"/><path d="M5 2h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1z"/></svg>' },
    'pants_4': { name: "Gezgin Pantolonu", category: 'Zırh', subCategory: 'Pantolon', baseRarity: 'rare', requiredLevel: 13, stats: { armor: 9, speed: 4 }, buyPrice: 0, sellPrice: 300, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-600"><path d="M12 2v20"/><path d="M4 2v20"/><path d="M20 2v20"/><path d="M5 2h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1z"/></svg>' },
    'pants_5': { name: "Alev Bacaklıkları", category: 'Zırh', subCategory: 'Pantolon', baseRarity: 'epic', requiredLevel: 26, stats: { armor: 18, damage: 5 }, buyPrice: 0, sellPrice: 1300, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-orange-500"><path d="M12 2v20"/><path d="M4 2v20"/><path d="M20 2v20"/><path d="M5 2h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1z"/></svg>' },

    // -- Ayakkabı
    'boots_1': { name: "Yıpranmış Çizme", category: 'Zırh', subCategory: 'Ayakkabı', baseRarity: 'common', requiredLevel: 2, stats: { armor: 2, speed: 1 }, buyPrice: 35, sellPrice: 17, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-800"><path d="M6 14a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H6Z"/><path d="M4 14v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4"/></svg>' },
    'boots_2': { name: "Demir Çizme", category: 'Zırh', subCategory: 'Ayakkabı', baseRarity: 'common', requiredLevel: 8, stats: { armor: 7 }, buyPrice: 180, sellPrice: 90, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-500"><path d="M6 14a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H6Z"/><path d="M4 14v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4"/></svg>' },
    'boots_3': { name: "Gezgin Botları", category: 'Zırh', subCategory: 'Ayakkabı', baseRarity: 'rare', requiredLevel: 11, stats: { armor: 4, speed: 5 }, buyPrice: 400, sellPrice: 200, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-600"><path d="M6 14a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H6Z"/><path d="M4 14v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4"/></svg>' },
    'boots_4': { name: "Sessizlik Çizmeleri", category: 'Zırh', subCategory: 'Ayakkabı', baseRarity: 'rare', requiredLevel: 17, stats: { armor: 6, dodge: 4 }, buyPrice: 0, sellPrice: 420, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-violet-500"><path d="M6 14a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H6Z"/><path d="M4 14v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4"/></svg>' },
    'boots_5': { name: "Uçan Sandaletler", category: 'Zırh', subCategory: 'Ayakkabı', baseRarity: 'epic', requiredLevel: 25, stats: { armor: 10, speed: 10, dodge: 5 }, buyPrice: 0, sellPrice: 1500, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-cyan-300"><path d="M6 14a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H6Z"/><path d="M4 14v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4"/></svg>' },

    // -- Eldiven
    'gloves_1': { name: "Kumaş Eldiven", category: 'Zırh', subCategory: 'Eldiven', baseRarity: 'common', requiredLevel: 2, stats: { armor: 1 }, buyPrice: 20, sellPrice: 10, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-300"><path d="M17 11.5V9a2 2 0 0 0-2-2h-5a2 2 0 0 0-2 2v2.5"/><path d="M17 11.5a2 2 0 0 1-2 2h-5a2 2 0 0 1-2-2"/><path d="M4 14v-2.5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2V14"/></svg>' },
    'gloves_2': { name: "Demir Eldiven", category: 'Zırh', subCategory: 'Eldiven', baseRarity: 'common', requiredLevel: 7, stats: { armor: 5 }, buyPrice: 140, sellPrice: 70, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-500"><path d="M17 11.5V9a2 2 0 0 0-2-2h-5a2 2 0 0 0-2 2v2.5"/><path d="M17 11.5a2 2 0 0 1-2 2h-5a2 2 0 0 1-2-2"/><path d="M4 14v-2.5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2V14"/><path d="M8 18h8"/></svg>' },
    'gloves_3': { name: "Güç Eldivenleri", category: 'Zırh', subCategory: 'Eldiven', baseRarity: 'rare', requiredLevel: 12, stats: { armor: 4, damage: 5 }, buyPrice: 480, sellPrice: 240, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-red-500"><path d="M17 11.5V9a2 2 0 0 0-2-2h-5a2 2 0 0 0-2 2v2.5"/><path d="M17 11.5a2 2 0 0 1-2 2h-5a2 2 0 0 1-2-2"/><path d="M4 14v-2.5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2V14"/><path d="M8 18h8"/></svg>' },
    'gloves_4': { name: "Hırsız Eldiveni", category: 'Zırh', subCategory: 'Eldiven', baseRarity: 'rare', requiredLevel: 16, stats: { armor: 3, dodge: 3 }, buyPrice: 0, sellPrice: 350, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-700"><path d="M17 11.5V9a2 2 0 0 0-2-2h-5a2 2 0 0 0-2 2v2.5"/><path d="M17 11.5a2 2 0 0 1-2 2h-5a2 2 0 0 1-2-2"/><path d="M4 14v-2.5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2V14"/></svg>' },
    'gloves_5': { name: "Devlerin Elleri", category: 'Zırh', subCategory: 'Eldiven', baseRarity: 'epic', requiredLevel: 27, stats: { armor: 10, damage: 8, hp: 40 }, buyPrice: 0, sellPrice: 1600, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-orange-600"><path d="M17 11.5V9a2 2 0 0 0-2-2h-5a2 2 0 0 0-2 2v2.5"/><path d="M17 11.5a2 2 0 0 1-2 2h-5a2 2 0 0 1-2-2"/><path d="M4 14v-2.5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2V14"/><path d="M8 18h8"/></svg>' },

    // =================================================================================
    // EKLENTİLER
    // =================================================================================
    // -- Kolye
    'necklace_1': { name: "Sağlık Tılsımı", category: 'Eklenti', subCategory: 'Kolye', baseRarity: 'common', requiredLevel: 5, stats: { hp: 50 }, buyPrice: 200, sellPrice: 100, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-red-400"><path d="M12 22a7 7 0 0 0 7-7h-2a5 5 0 0 1-5 5 5 5 0 0 1-5-5H5a7 7 0 0 0 7 7z"/><path d="M5 15a7 7 0 0 0 14 0h-2a5 5 0 0 1-10 0z"/><path d="M12 12h.01"/></svg>' },
    'necklace_2': { name: "Mana Kolyesi", category: 'Eklenti', subCategory: 'Kolye', baseRarity: 'common', requiredLevel: 10, stats: { mana: 40 }, buyPrice: 200, sellPrice: 100, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-400"><path d="M12 22a7 7 0 0 0 7-7h-2a5 5 0 0 1-5 5 5 5 0 0 1-5-5H5a7 7 0 0 0 7 7z"/><path d="M5 15a7 7 0 0 0 14 0h-2a5 5 0 0 1-10 0z"/><circle cx="12" cy="12" r="3"/></svg>' },
    'necklace_3': { name: "Savaşçı Kolyesi", category: 'Eklenti', subCategory: 'Kolye', baseRarity: 'rare', requiredLevel: 15, stats: { damage: 5, hp: 30 }, buyPrice: 600, sellPrice: 300, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-orange-500"><path d="M12 22a7 7 0 0 0 7-7h-2a5 5 0 0 1-5 5 5 5 0 0 1-5-5H5a7 7 0 0 0 7 7z"/><path d="M5 15a7 7 0 0 0 14 0h-2a5 5 0 0 1-10 0z"/><path d="m9 12 6-6"/></svg>' },
    'necklace_4': { name: "Koruma Amuleti", category: 'Eklenti', subCategory: 'Kolye', baseRarity: 'rare', requiredLevel: 20, stats: { damageReduction: 3, armor: 5 }, buyPrice: 0, sellPrice: 550, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-cyan-400"><path d="M12 22a7 7 0 0 0 7-7h-2a5 5 0 0 1-5 5 5 5 0 0 1-5-5H5a7 7 0 0 0 7 7z"/><path d="M5 15a7 7 0 0 0 14 0h-2a5 5 0 0 1-10 0z"/><path d="M12 14a2 2 0 0 0-2 2v2h4v-2a2 2 0 0 0-2-2z"/></svg>' },
    'necklace_5': { name: "Kralın Yadigarı", category: 'Eklenti', subCategory: 'Kolye', baseRarity: 'legendary', requiredLevel: 30, stats: { damage: 10, hp: 100, damageReduction: 2 }, buyPrice: 0, sellPrice: 2800, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-400"><path d="M12 22a7 7 0 0 0 7-7h-2a5 5 0 0 1-5 5 5 5 0 0 1-5-5H5a7 7 0 0 0 7 7z"/><path d="M5 15a7 7 0 0 0 14 0h-2a5 5 0 0 1-10 0z"/><path d="m10 9 2 3 2-3"/><path d="m12 12-2 3h4l-2-3z"/></svg>' },

    // -- Bilezik
    'bracelet_1': { name: "Deri Bileklik", category: 'Eklenti', subCategory: 'Bilezik', baseRarity: 'common', requiredLevel: 4, stats: { hp: 20 }, buyPrice: 80, sellPrice: 40, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-700"><path d="M10 17a5 5 0 0 1-5-5 5 5 0 0 1 5-5h1a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-1z"/></svg>' },
    'bracelet_2': { name: "Hız Bileziği", category: 'Eklenti', subCategory: 'Bilezik', baseRarity: 'common', requiredLevel: 9, stats: { speed: 5 }, buyPrice: 280, sellPrice: 140, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-400"><path d="M10 17a5 5 0 0 1-5-5 5 5 0 0 1 5-5h1a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-1z"/><path d="M7 17a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5h-1z"/></svg>' },
    'bracelet_3': { name: "Güç Bilekliği", category: 'Eklenti', subCategory: 'Bilezik', baseRarity: 'rare', requiredLevel: 13, stats: { damage: 4 }, buyPrice: 520, sellPrice: 260, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-red-500"><path d="M10 17a5 5 0 0 1-5-5 5 5 0 0 1 5-5h1a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-1z"/></svg>' },
    'bracelet_4': { name: "Can Taşı Bilekliği", category: 'Eklenti', subCategory: 'Bilezik', baseRarity: 'rare', requiredLevel: 19, stats: { hp: 120 }, buyPrice: 0, sellPrice: 600, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-500"><path d="M10 17a5 5 0 0 1-5-5 5 5 0 0 1 5-5h1a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-1z"/><path d="M7 17a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5h-1z"/></svg>' },
    'bracelet_5': { name: "Kaderin Kelepçesi", category: 'Eklenti', subCategory: 'Bilezik', baseRarity: 'epic', requiredLevel: 27, stats: { damage: 8, speed: 8 }, buyPrice: 0, sellPrice: 1800, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-purple-500"><path d="M10 17a5 5 0 0 1-5-5 5 5 0 0 1 5-5h1a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-1z"/><path d="M7 17a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5h-1z"/></svg>' },

    // -- Küpe
    'earring_1': { name: "Basit Halka Küpe", category: 'Eklenti', subCategory: 'Küpe', baseRarity: 'common', requiredLevel: 3, stats: { dodge: 1 }, buyPrice: 90, sellPrice: 45, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-300"><circle cx="12" cy="5" r="3"/><path d="M10 12a5 5 0 0 0 5 5h.5a3.5 3.5 0 0 1 3.5 3.5V21a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-1.5a3.5 3.5 0 0 1 3.5-3.5H9a5 5 0 0 0 5-5z"/></svg>' },
    'earring_2': { name: "Bilgelik Küpesi", category: 'Eklenti', subCategory: 'Küpe', baseRarity: 'common', requiredLevel: 8, stats: { mana: 30 }, buyPrice: 220, sellPrice: 110, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-purple-400"><circle cx="12" cy="5" r="3"/><path d="M10 12a5 5 0 0 0 5 5h.5a3.5 3.5 0 0 1 3.5 3.5V21a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-1.5a3.5 3.5 0 0 1 3.5-3.5H9a5 5 0 0 0 5-5z"/></svg>' },
    'earring_3': { name: "Keskin Göz Küpesi", category: 'Eklenti', subCategory: 'Küpe', baseRarity: 'rare', requiredLevel: 12, stats: { speed: 4, dodge: 2 }, buyPrice: 450, sellPrice: 225, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-cyan-400"><circle cx="12" cy="5" r="3"/><path d="M10 12a5 5 0 0 0 5 5h.5a3.5 3.5 0 0 1 3.5 3.5V21a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-1.5a3.5 3.5 0 0 1 3.5-3.5H9a5 5 0 0 0 5-5z"/></svg>' },
    'earring_4': { name: "Kanlı Yakut Küpe", category: 'Eklenti', subCategory: 'Küpe', baseRarity: 'rare', requiredLevel: 18, stats: { hp: 80, damage: 3 }, buyPrice: 0, sellPrice: 580, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-red-500"><circle cx="12" cy="5" r="3"/><path d="M10 12a5 5 0 0 0 5 5h.5a3.5 3.5 0 0 1 3.5 3.5V21a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-1.5a3.5 3.5 0 0 1 3.5-3.5H9a5 5 0 0 0 5-5z"/></svg>' },
    'earring_5': { name: "Fırtına Gözü", category: 'Eklenti', subCategory: 'Küpe', baseRarity: 'epic', requiredLevel: 26, stats: { damage: 7, speed: 7 }, buyPrice: 0, sellPrice: 1700, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-400"><circle cx="12" cy="5" r="3"/><path d="M10 12a5 5 0 0 0 5 5h.5a3.5 3.5 0 0 1 3.5 3.5V21a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-1.5a3.5 3.5 0 0 1 3.5-3.5H9a5 5 0 0 0 5-5z"/></svg>' },

    // -- Kemer
    'belt_1': { name: "Basit Kemer", category: 'Eklenti', subCategory: 'Kemer', baseRarity: 'common', requiredLevel: 5, stats: { hp: 30 }, buyPrice: 100, sellPrice: 50, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-700"><path d="M3 12h18M5 12V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v5"/><path d="M5 12v5a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-5"/></svg>' },
    'belt_2': { name: "Takviyeli Kemer", category: 'Eklenti', subCategory: 'Kemer', baseRarity: 'common', requiredLevel: 10, stats: { armor: 3, hp: 40 }, buyPrice: 250, sellPrice: 125, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-400"><path d="M3 12h18M5 12V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v5"/><path d="M5 12v5a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-5"/><path d="M12 7V2"/><path d="M12 17v5"/></svg>' },
    'belt_3': { name: "Metanet Kemeri", category: 'Eklenti', subCategory: 'Kemer', baseRarity: 'rare', requiredLevel: 15, stats: { damageReduction: 3 }, buyPrice: 700, sellPrice: 350, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-500"><path d="M3 12h18M5 12V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v5"/><path d="M5 12v5a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-5"/><path d="M12 7V2"/><path d="M12 17v5"/></svg>' },
    'belt_4': { name: "Dev Kemeri", category: 'Eklenti', subCategory: 'Kemer', baseRarity: 'epic', requiredLevel: 22, stats: { hp: 150, damage: 5 }, buyPrice: 0, sellPrice: 1100, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-red-600"><path d="M3 12h18M5 12V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v5"/><path d="M5 12v5a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-5"/><path d="M12 7V2"/><path d="M12 17v5"/></svg>' },
    'belt_5': { name: "Titan Kuşağı", category: 'Eklenti', subCategory: 'Kemer', baseRarity: 'legendary', requiredLevel: 33, stats: { hp: 200, damageReduction: 4 }, buyPrice: 0, sellPrice: 3000, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-purple-500"><path d="M3 12h18M5 12V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v5"/><path d="M5 12v5a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-5"/><path d="M12 7V2"/><path d="M12 17v5"/></svg>' },

    // -- Binek
    'mount_1': { name: "Yaşlı At", category: 'Eklenti', subCategory: 'Binek', baseRarity: 'common', requiredLevel: 10, stats: { travelTimeReduction: 5 }, buyPrice: 1000, sellPrice: 500, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-700"><path d="M12 2a2 2 0 0 0-2 2v2h4V4a2 2 0 0 0-2-2z"/><path d="M4 14s1-1 4-1 5 2 8 2 4-1 4-1V6s-1 1-4 1-5-2-8-2-4 1-4 1z"/><path d="M4 6v8"/><path d="M20 6v8"/></svg>' },
    'mount_2': { name: "Atik At", category: 'Eklenti', subCategory: 'Binek', baseRarity: 'rare', requiredLevel: 15, stats: { travelTimeReduction: 10 }, buyPrice: 5000, sellPrice: 2500, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-600"><path d="M12 2a2 2 0 0 0-2 2v2h4V4a2 2 0 0 0-2-2z"/><path d="M4 14s1-1 4-1 5 2 8 2 4-1 4-1V6s-1 1-4 1-5-2-8-2-4 1-4 1z"/><path d="M4 6v8"/><path d="M20 6v8"/><path d="M8 18h8"/></svg>' },
    'mount_3': { name: "Zırhlı Savaş Atı", category: 'Eklenti', subCategory: 'Binek', baseRarity: 'rare', requiredLevel: 20, stats: { travelTimeReduction: 8, armor: 10 }, buyPrice: 8000, sellPrice: 4000, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-500"><path d="M12 2a2 2 0 0 0-2 2v2h4V4a2 2 0 0 0-2-2z"/><path d="M4 14s1-1 4-1 5 2 8 2 4-1 4-1V6s-1 1-4 1-5-2-8-2-4 1-4 1z"/><path d="M4 6v8"/><path d="M20 6v8"/><path d="M8 18h8"/></svg>' },
    'mount_4': { name: "Bozkurt", category: 'Eklenti', subCategory: 'Binek', baseRarity: 'epic', requiredLevel: 25, stats: { travelTimeReduction: 15, damage: 5 }, buyPrice: 0, sellPrice: 7000, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-cyan-200"><path d="M12 2a2 2 0 0 0-2 2v2h4V4a2 2 0 0 0-2-2z"/><path d="M4 14s1-1 4-1 5 2 8 2 4-1 4-1V6s-1 1-4 1-5-2-8-2-4 1-4 1z"/><path d="M4 6v8"/><path d="M20 6v8"/><path d="M12 14v4"/></svg>' },
    'mount_5': { name: "Gryphon", category: 'Eklenti', subCategory: 'Binek', baseRarity: 'legendary', requiredLevel: 35, stats: { travelTimeReduction: 25, dodge: 5 }, buyPrice: 0, sellPrice: 15000, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-purple-300"><path d="M12 2a2 2 0 0 0-2 2v2h4V4a2 2 0 0 0-2-2z"/><path d="M4 14s1-1 4-1 5 2 8 2 4-1 4-1V6s-1 1-4 1-5-2-8-2-4 1-4 1z"/><path d="M4 6v8"/><path d="M20 6v8"/><path d="m6 18 6-4 6 4"/></svg>' },
    
    // -- Dövme
    'tattoo_1': { name: "Savaşçı Dövmesi", category: 'Eklenti', subCategory: 'Dövme', baseRarity: 'common', requiredLevel: 6, stats: { hp: 40 }, buyPrice: 180, sellPrice: 90, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-400"><path d="M12 22s-8-4.5-8-12V5l8-3 8 3v5c0 7.5-8 12-8 12z"/><path d="m9 12 2 2 4-4"/></svg>' },
    'tattoo_2': { name: "Hız Dövmesi", category: 'Eklenti', subCategory: 'Dövme', baseRarity: 'common', requiredLevel: 9, stats: { speed: 4 }, buyPrice: 260, sellPrice: 130, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-400"><path d="m12 12-3-3 3-3 3 3-3 3z"/><path d="m20.5 10.9-3-3a.5.5 0 0 0-.7 0l-3 3c-.2.2-.2.5 0 .7l3 3a.5.5 0 0 0 .7 0l3-3a.5.5 0 0 0 0-.7z"/><path d="m3.5 10.9 3-3a.5.5 0 0 1 .7 0l3 3c.2.2.2.5 0 .7l-3 3a.5.5 0 0 1-.7 0l-3-3a.5.5 0 0 1 0-.7z"/></svg>' },
    'tattoo_3': { name: "Yılan Dövmesi", category: 'Eklenti', subCategory: 'Dövme', baseRarity: 'rare', requiredLevel: 14, stats: { dodge: 4 }, buyPrice: 650, sellPrice: 325, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-500"><path d="M6.1 2.3a1 1 0 0 1 1.3.5l.3 1.2a1 1 0 0 0 1.3.5l1.2-.3a1 1 0 0 1 1.1.9l-.2 1.3a1 1 0 0 0 .6 1.1l1.3.2a1 1 0 0 1 .6 1.3l-1.2.3a1 1 0 0 0-.5 1.3l.3 1.2a1 1 0 0 1-.9 1.1l-1.3-.2a1 1 0 0 0-1.1.6l-.2 1.3a1 1 0 0 1-1.3.6l-.3-1.2a1 1 0 0 0-1.3-.5l-1.2.3a1 1 0 0 1-1.1-.9l.2-1.3a1 1 0 0 0-.6-1.1l-1.3-.2a1 1 0 0 1-.6-1.3l1.2-.3a1 1 0 0 0 .5-1.3l-.3-1.2a1 1 0 0 1 .9-1.1l1.3.2a1 1 0 0 0 1.1-.6z"/><path d="m14 16 2-2-2-2"/><path d="m10 16-2-2 2-2"/></svg>' },
    'tattoo_4': { name: "Canavar Gözü Dövmesi", category: 'Eklenti', subCategory: 'Dövme', baseRarity: 'epic', requiredLevel: 22, stats: { damage: 6, hp: 50 }, buyPrice: 0, sellPrice: 1200, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-purple-500"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>' },
    'tattoo_5': { name: "Ejderha Damgası", category: 'Eklenti', subCategory: 'Dövme', baseRarity: 'legendary', requiredLevel: 30, stats: { damage: 8, damageReduction: 2, hp: 80 }, buyPrice: 0, sellPrice: 2900, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-red-600"><path d="M4.5 16.5c-2.1-2.4-2.8-5.8.2-8C8.3 4.9 13.2 4 16 4c.7 0 1.3.1 1.9.2"/><path d="M20.5 7.5c2.2 2.4 2.8 5.8-.2 8-3.6 3.6-8.5 4.5-11.3 4.5-.7 0-1.3-.1-1.9-.2"/><path d="m15 14.5-3-3 3-3"/><path d="m9 9.5 3 3-3 3"/></svg>' },

    // -- Evcil Hayvan
    'pet_1': { name: "Sokak Kedisi", category: 'Eklenti', subCategory: 'Evcil Hayvan', baseRarity: 'common', requiredLevel: 5, stats: { dodge: 2 }, buyPrice: 500, sellPrice: 250, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-400"><path d="M12 12c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4z"/><path d="M12 12v3a4 4 0 0 1-4 4H4v-3a4 4 0 0 1 4-4h4z"/></svg>' },
    'pet_2': { name: "Sincap", category: 'Eklenti', subCategory: 'Evcil Hayvan', baseRarity: 'common', requiredLevel: 8, stats: { speed: 3 }, buyPrice: 750, sellPrice: 375, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-700"><path d="M16 8a4 4 0 0 0-4-4h-1a4 4 0 0 0-4 4v2"/><path d="M16 14a4 4 0 0 0-4-4h-1a4 4 0 0 0-4 4v2"/><path d="M12 22a4 4 0 0 0 4-4v-2a4 4 0 0 0-4-4h-1a4 4 0 0 0-4 4v2a4 4 0 0 0 4 4z"/></svg>' },
    'pet_3': { name: "Avcı Şahini", category: 'Eklenti', subCategory: 'Evcil Hayvan', baseRarity: 'rare', requiredLevel: 15, stats: { damage: 5, speed: 2 }, buyPrice: 2500, sellPrice: 1250, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-300"><path d="M12 2c-3.3 0-6 2.7-6 6v2c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V8c0-3.3-2.7-6-6-6z"/><path d="M12 12v3a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-3"/><path d="M12 12v3a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-3"/></svg>' },
    'pet_4': { name: "Buz Kurdu", category: 'Eklenti', subCategory: 'Evcil Hayvan', baseRarity: 'epic', requiredLevel: 24, stats: { damage: 8, hp: 60 }, buyPrice: 0, sellPrice: 4000, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-cyan-200"><path d="M12 12c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4z"/><path d="M12 12v3a4 4 0 0 1-4 4H4v-3a4 4 0 0 1 4-4h4z"/><path d="M12 12v3a4 4 0 0 0 4 4h4v-3a4 4 0 0 0-4-4h-4z"/></svg>' },
    'pet_5': { name: "Alev Anka Kuşu", category: 'Eklenti', subCategory: 'Evcil Hayvan', baseRarity: 'legendary', requiredLevel: 35, stats: { damage: 12, hp: 100, damageReduction: 1 }, buyPrice: 0, sellPrice: 9000, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-orange-500"><path d="M12 2c-3.3 0-6 2.7-6 6v2c0 1.1.9 2 2 2h8a2 2 0 0 0 2-2V8c0-3.3-2.7-6-6-6z"/><path d="M12 12v3a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-3"/><path d="M12 12v3a2 2 0 0 0 2 2h2a2 2 0 0 0 2-2v-3"/><path d="M7 22h10"/><path d="m9 18 3-3 3 3"/></svg>' },

    // =================================================================================
    // CANAVAR PARÇALARI
    // =================================================================================
    'monster_1': { name: "Goblin Kulağı", category: 'Canavar Parçası', baseRarity: 'common', requiredLevel: 0, buyPrice: 0, sellPrice: 10, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-700"><path d="M6 11.5a5.5 5.5 0 0 1 11 0C17 16 12 22 12 22s-5-6-5-10.5Z"/><path d="M14.5 9a2.5 2.5 0 0 0-5 0"/></svg>' },
    'monster_2': { name: "Kurt Postu", category: 'Canavar Parçası', baseRarity: 'common', requiredLevel: 0, buyPrice: 0, sellPrice: 15, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-gray-400"><path d="M12 12c-2.2 0-4-1.8-4-4s1.8-4 4-4 4 1.8 4 4-1.8 4-4 4z"/><path d="M12 12v3a4 4 0 0 1-4 4H4v-3a4 4 0 0 1 4-4h4z"/></svg>' },
    'monster_3': { name: "Dev Gözü", category: 'Canavar Parçası', baseRarity: 'uncommon', requiredLevel: 0, buyPrice: 0, sellPrice: 50, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-blue-300"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>' },
    'monster_4': { name: "Wyvern Zehiri", category: 'Canavar Parçası', baseRarity: 'rare', requiredLevel: 0, buyPrice: 0, sellPrice: 110, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-purple-600"><path d="M8 20a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V8H8v12Z"/><path d="M5.4 5.4a4 4 0 0 1 5.2 0L12 6.8l1.4-1.4a4 4 0 1 1 5.2 5.2L12 18l-6.6-6.6a4 4 0 0 1 0-5.2Z"/></svg>' },
    'monster_5': { name: "Minotor Boynuzu", category: 'Canavar Parçası', baseRarity: 'uncommon', requiredLevel: 0, buyPrice: 0, sellPrice: 90, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-yellow-700"><path d="M3 3a2 2 0 0 1 4 0L12 9l5-6a2 2 0 1 1 4 0v5a8 8 0 0 1-8 8 8 8 0 0 1-8-8V3Z"/></svg>' },
    'monster_6': { name: "Hayalet Özü", category: 'Canavar Parçası', baseRarity: 'epic', requiredLevel: 0, buyPrice: 0, sellPrice: 175, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-indigo-200"><path d="M12 2a4 4 0 0 0-4 4c0 1.6.8 2.9 2 3.7V12h-2v4h4v-4h-2V9.7c1.2-.8 2-2.1 2-3.7a4 4 0 0 0-4-4Z"/><path d="M10.5 16a1.5 1.5 0 0 0 3 0"/><path d="M6.5 16a1.5 1.5 0 0 0 3 0"/><path d="M14.5 16a1.5 1.5 0 0 0 3 0"/></svg>' },
    'monster_7': { name: "Ejderha Pulu", category: 'Canavar Parçası', baseRarity: 'legendary', requiredLevel: 0, buyPrice: 0, sellPrice: 500, icon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-orange-500"><path d="m2 14 4.1 4.1c.3.3.7.4 1.1.4h9.6c.4 0 .8-.1 1.1-.4L22 14"/></svg>' }
};

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase başarıyla başlatıldı.");
        } catch (e) { console.error("Firebase başlatma hatası.", e); }

        const STAT_CONFIG = {
            base: { hp: 100, damage: 10, mana: 10, energy: 100, fame: 1000, dodgeChance: 5, damageReduction: 0, travelTimeReduction: 0, marketDiscount: 0 },
            perPoint: {
                guc: { damage: 3, hp: 5 },
                zeka: { mana: 5, marketDiscount: 0.5 },
                hiz: { damage: 1, dodgeChance: 1, travelTimeReduction: 0.5 },
                tanklik: { hp: 20, damage: 1.2, damageReduction: 0.1, dodgeChance: -0.2 }
            },
            caps: { marketDiscount: 50, dodgeChance: 50, travelTimeReduction: 75, damageReduction: 40 }
        };
        const STAT_DESCRIPTIONS = {
            guc: '<h3>💪 Güç</h3><p>Her puan +3 Hasar ve +5 Can verir. Fiziksel saldırıların temelini oluşturur.</p>',
            zeka: '<h3>🔮 Zeka</h3><p>Her puan +5 Mana ve marketlerde %0.5 indirim (Maks %50) sağlar. Ayrıca şans faktörünü etkiler.</p>',
            hiz: '<h3>🏹 Hız</h3><p>Her puan +1 Hasar, +%1 Kaçınma Şansı (Maks %50) ve seyahat sürelerinde %0.5 kısalma (Maks %75) sağlar.</p>',
            tanklik: '<h3>🛡️ Tanklık</h3><p>Her puan +20 Can, +1.2 Hasar ve +%0.1 Hasar Azaltma (Maks %40) verir. Ancak Kaçınma Şansını %0.2 düşürür.</p>'
        };
        const eyeOrigins = [{ x: 90, y: 75 }, { x: 110, y: 75 }];
        const maxMove = 2.5;

        // Screen and UI element references
        const authScreen = document.getElementById('auth-screen'), mainMenuScreen = document.getElementById('main-menu-screen'), characterCreationScreen = document.getElementById('character-creation-screen'), gameScreen = document.getElementById('game-screen');
        const villageView = document.getElementById('village-view');
        const homeScreen = document.getElementById('home-screen'), arenaScreen = document.getElementById('arena-screen'), marketScreen = document.getElementById('market-screen');
        const garageScreen = document.getElementById('garage-screen'), gardenScreen = document.getElementById('garden-screen'), basementScreen = document.getElementById('basement-screen');
        const homeButton = document.getElementById('home-button'), arenaButton = document.getElementById('arena-button'), marketButton = document.getElementById('market-button');
        const goToGarageBtn = document.getElementById('go-to-garage'), goToGardenBtn = document.getElementById('go-to-garden'), goToBasementBtn = document.getElementById('go-to-basement');
        const arenaMainView = document.getElementById('arena-main-view'), leaguesScreen = document.getElementById('leagues-screen'), dungeonsScreen = document.getElementById('dungeons-screen');
        const showLeaguesButton = document.getElementById('show-leagues-button'), showDungeonsButton = document.getElementById('show-dungeons-button');
        const marketMainView = document.getElementById('market-main-view'), marketBuyScreen = document.getElementById('market-buy-screen'), marketSellScreen = document.getElementById('market-sell-screen'), marketTradeScreen = document.getElementById('market-trade-screen');
        const showMarketBuyButton = document.getElementById('show-market-buy-button'), showMarketSellButton = document.getElementById('show-market-sell-button'), showMarketTradeButton = document.getElementById('show-market-trade-button');
        
        // Basement and Market UI Elements
        const openBasementMenuBtn = document.getElementById('open-basement-menu');
        const basementMenuScreen = document.getElementById('basement-menu-screen');
        const closeBasementMenuBtn = document.getElementById('close-basement-menu');
        const showDevelopmentsBtn = document.getElementById('show-developments-button');
        const showEmployeesBtn = document.getElementById('show-employees-button');
        const developmentsScreen = document.getElementById('developments-screen');
        const employeesScreen = document.getElementById('employees-screen');
        const backToBasementMenuBtns = document.querySelectorAll('.back-to-basement-menu');
        
        const globalUi = document.getElementById('global-ui'), settingsModal = document.getElementById('settings-modal'), characterSheetModal = document.getElementById('character-sheet-modal');
        const loginForm = document.getElementById('login-form'), registerForm = document.getElementById('register-form');
        const authMessage = document.getElementById('auth-message');
        const loginTabBtn = document.getElementById('login-tab-button'), registerTabBtn = document.getElementById('register-tab-button');
        const googleSignInBtn = document.getElementById('google-signin-button');
        const userDisplay = document.getElementById('user-display'), uidDisplay = document.getElementById('uid-display');
        const startGameBtn = document.getElementById('start-game-button');
        const globalSettingsBtn = document.getElementById('global-settings-button'), closeSettingsModalBtn = document.getElementById('close-settings-modal'), logoutBtn = document.getElementById('logout-button');
        const redeemCodeButton = document.getElementById('redeem-code-button'), giftCodeMessage = document.getElementById('gift-code-message');
        const characterCreationForm = document.getElementById('character-creation-form'), createCharacterBtn = document.getElementById('create-character-button');
        const nameValidationMessage = document.getElementById('name-validation-message');
        const playerProfileButton = document.getElementById('player-profile-button'), closeCharacterSheetButton = document.getElementById('close-character-sheet-button');
        const statTooltip = document.getElementById('stat-tooltip');
        // Chest UI elements
        const chestModal = document.getElementById('chest-modal');
        const openChestButton = document.getElementById('open-chest-button');
        const closeChestButton = document.getElementById('close-chest-button');
        const chestPlayerInventory = document.getElementById('chest-player-inventory');
        const chestHouseInventory = document.getElementById('chest-house-inventory');
        const chestPageButtons = document.querySelectorAll('.chest-page-btn');
        const wardrobeScreen = document.getElementById('wardrobe-screen');
        const openWardrobeButton = document.getElementById('open-wardrobe-button');
        const confirmWardrobeChangeButton = document.getElementById('confirm-wardrobe-change-button');
        
        let selectedWardrobeGender, selectedWardrobeSkinColor, selectedWardrobeHairColor;
        let currentUserData = null, unsubscribeUser;
        let isResettingCharacter = false;
        let statClickTracker = {};
        let selectedGender = 'male', selectedSkinColor = '#e0ac69', selectedHairColor = '#5D4037';
        let currentChestPage = 1;
        let currentMarketCategory = 'Silah';
        const skinColors = ['#F2D0B1', '#E0AC69', '#C68642', '#8D5524', '#614332'];
        const hairColors = ['#2C222B', '#5D4037', '#A16E4B', '#B8860B', '#F8F8FF', '#D2691E'];

        let currentMarketSubCategory = null;
        let isInitialLoad = true; // << YENİ EKLENEN DEĞİŞKEN

        // YENİ: Alt kategori konfigürasyonu
        const SUB_CATEGORIES = {
            'Silah': ['Kısa kılıç', 'Uzun kılıç', 'Hançer', 'Balta', 'Topuz', 'Menzilliler', 'Asa', 'Büyü kitabı'],
            'Zırh': ['Kask', 'Göğüslük', 'Pantolon', 'Ayakkabı', 'Eldiven'],
            'Eklenti': ['Kolye', 'Bilezik', 'Küpe', 'Kemer', 'Binek', 'Dövme', 'Evcil Hayvan']
        };

        const SLOT_TYPE_TO_KEY_MAP = {
            'Silah': 'weapon',
            'Kask': 'helmet',
            'Göğüslük': 'chest',
            'Pantolon': 'pants',
            'Ayakkabı': 'boots',
            'Eldiven': 'gloves',
            'Kolye': 'necklace',
            'Bilezik': 'bracelet',
            'Küpe': 'earring',
            'Kemer': 'belt'
        };

        const EQUIPMENT_SLOT_PLACEHOLDERS = {
            weapon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 opacity-20"><path d="M14.5 17.5 3 6V3h3l11.5 11.5"/><path d="m21 15-6-6"/><path d="M3.5 17.5 9 12"/><path d="M15 3.5 12 9"/></svg>',
            helmet: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 opacity-20"><path d="M12 2a4 4 0 0 0-4 4v2h8V6a4 4 0 0 0-4-4Z"/><path d="M18 12h-1.3a2 2 0 0 1-1.9-2.8l1.1-3.9a1 1 0 0 0-1-1.2h-4.8a1 1 0 0 0-1 1.2l1.1 3.8a2 2 0 0 1-2 2.8H6"/><path d="M12 22a4 4 0 0 0 4-4h-8a4 4 0 0 0 4 4Z"/></svg>',
            chest: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 opacity-20"><path d="M21 15a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><path d="M6 10V8a6 6 0 0 1 12 0v2"/></svg>',
            pants: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 opacity-20"><path d="M12 2v20"/><path d="M4 2v20"/><path d="M20 2v20"/><path d="M5 2h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1z"/></svg>',
            boots: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 opacity-20"><path d="M6 14a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2H6Z"/><path d="M4 14v4a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-4"/></svg>',
            gloves: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 opacity-20"><path d="M17 11.5V9a2 2 0 0 0-2-2h-5a2 2 0 0 0-2 2v2.5"/><path d="M17 11.5a2 2 0 0 1-2 2h-5a2 2 0 0 1-2-2"/><path d="M4 14v-2.5a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2V14"/><path d="M8 18h8"/></svg>',
            necklace: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 opacity-20"><path d="M12 22a7 7 0 0 0 7-7h-2a5 5 0 0 1-5 5 5 5 0 0 1-5-5H5a7 7 0 0 0 7 7z"/><path d="M5 15a7 7 0 0 0 14 0h-2a5 5 0 0 1-10 0z"/><circle cx="12" cy="12" r="3"/></svg>',
            bracelet: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 opacity-20"><path d="M10 17a5 5 0 0 1-5-5 5 5 0 0 1 5-5h1a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-1z"/><path d="M7 17a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5h1a2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5h-1z"/></svg>',
            earring: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 opacity-20"><circle cx="12" cy="5" r="3"/><path d="M10 12a5 5 0 0 0 5 5h.5a3.5 3.5 0 0 1 3.5 3.5V21a2 2 0 0 1-2 2h-11a2 2 0 0 1-2-2v-1.5a3.5 3.5 0 0 1 3.5-3.5H9a5 5 0 0 0 5-5z"/></svg>',
            belt: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 opacity-20"><path d="M3 12h18M5 12V7a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v5"/><path d="M5 12v5a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-5"/><path d="M12 7V2"/><path d="M12 17v5"/></svg>',
        };
        
        let priceChart;
        let priceUpdateInterval;

        const itemTooltip = document.getElementById('item-tooltip');
        let quickSellSelectedIndices = [];
        let hideTooltipTimeout; // << EKLENECEK YENİ DEĞİŞKEN

        // Hızlı Sat için yeni element referansları
        const marketQuickSellScreen = document.getElementById('market-quick-sell-screen'); // Bunu birazdan HTML'e ekleyeceğiz
        const quickSellInventoryGrid = document.getElementById('quick-sell-inventory-grid');
        const quickSellTotal = document.getElementById('quick-sell-total');
        const quickSellConfirmButton = document.getElementById('quick-sell-confirm-button');
        const quickSellConfirmationModal = document.getElementById('quick-sell-confirmation-modal');
        const confirmSellYesBtn = document.getElementById('confirm-sell-yes-btn');
        const confirmSellNoBtn = document.getElementById('confirm-sell-no-btn');

        function showScreen(screen) {
            [authScreen, mainMenuScreen, gameScreen, characterCreationScreen].forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
            globalUi.classList.toggle('hidden', screen === authScreen || screen === characterCreationScreen);
            if (screen === gameScreen) {
                showVillageView();
            }
        }
        function showGameSubScreen(subScreen) {
            const allSubScreens = [villageView, homeScreen, arenaScreen, marketScreen, garageScreen, gardenScreen, basementScreen, basementMenuScreen, developmentsScreen, employeesScreen];
            allSubScreens.forEach(s => s.classList.add('hidden'));
            subScreen.classList.remove('hidden');
        }
        function showVillageView() {
             const allSubScreens = [homeScreen, arenaScreen, marketScreen, garageScreen, gardenScreen, basementScreen, basementMenuScreen, developmentsScreen, employeesScreen];
            allSubScreens.forEach(s => s.classList.add('hidden'));
            villageView.classList.remove('hidden');
        }
        function updateCharacterPreview(svgContainerId, characterData) {
            const masterSvg = document.getElementById('character-preview').innerHTML;
            const targetSvg = document.getElementById(svgContainerId);
            if (!targetSvg || !characterData) return;
            targetSvg.innerHTML = masterSvg;
            const { gender, skinColor, hairColor } = characterData;
            targetSvg.querySelectorAll('.character-skin-part').forEach(part => part.style.fill = skinColor);
            const isMale = gender === 'male';
            ['hair-male', 'hair-female-front', 'hair-female-back'].forEach(id => {
                const el = targetSvg.querySelector(`#${id}`);
                if (el) el.style.fill = hairColor;
            });
            ['body-male', 'hair-male-front-group'].forEach(id => {
                const el = targetSvg.querySelector(`#${id}`);
                if (el) el.classList.toggle('hidden', !isMale);
            });
            ['body-female', 'hair-female-front-group', 'hair-female-back-group'].forEach(id => {
                const el = targetSvg.querySelector(`#${id}`);
                if (el) el.classList.toggle('hidden', isMale);
            });
        }
        
        function updateCharacterSheetUI() {
            if (!currentUserData) return;

            // 1. STAT HESAPLAMALARI VE TEMEL BİLGİLER (Bu kısım sizde doğruydu)
            document.getElementById('gold-display').textContent = Math.floor(currentUserData.gold) || 0;
            document.getElementById('diamond-display').textContent = currentUserData.diamonds || 0;
            
            const energy = currentUserData.energy ?? 100;
            const maxEnergy = currentUserData.maxEnergy ?? 100;
            const energyPercent = (energy / maxEnergy) * 100;
            document.getElementById('energy-bar-fill').style.width = `${energyPercent}%`;
            document.getElementById('energy-bar-text').textContent = `⚡ ${energy}/${maxEnergy}`;

            const stats = currentUserData.stats || { guc: 1, zeka: 1, hiz: 1, tanklik: 1 };
            const baseStats = STAT_CONFIG.base;
            let calculated = { ...baseStats };
            calculated.hp = baseStats.hp + (stats.guc * STAT_CONFIG.perPoint.guc.hp) + (stats.tanklik * STAT_CONFIG.perPoint.tanklik.hp);
            calculated.damage = baseStats.damage + (stats.guc * STAT_CONFIG.perPoint.guc.damage) + (stats.hiz * STAT_CONFIG.perPoint.hiz.damage) + (stats.tanklik * STAT_CONFIG.perPoint.tanklik.damage);
            calculated.mana = baseStats.mana + (stats.zeka * STAT_CONFIG.perPoint.zeka.mana);
            calculated.marketDiscount = Math.min(stats.zeka * STAT_CONFIG.perPoint.zeka.marketDiscount, STAT_CONFIG.caps.marketDiscount);
            calculated.damageReduction = Math.min(stats.tanklik * STAT_CONFIG.perPoint.tanklik.damageReduction, STAT_CONFIG.caps.damageReduction);
            let dodgeFromSpeed = stats.hiz * STAT_CONFIG.perPoint.hiz.dodgeChance;
            let dodgePenaltyFromTank = stats.tanklik * STAT_CONFIG.perPoint.tanklik.dodgeChance;
            calculated.dodgeChance = Math.max(0, Math.min(baseStats.dodgeChance + dodgeFromSpeed + dodgePenaltyFromTank, STAT_CONFIG.caps.dodgeChance));
            calculated.travelTimeReduction = Math.min(stats.hiz * STAT_CONFIG.perPoint.hiz.travelTimeReduction, STAT_CONFIG.caps.travelTimeReduction);
            
            if (currentUserData.character) {
                updateCharacterPreview('profile-character-preview', currentUserData.character);
                updateCharacterPreview('sheet-character-preview', currentUserData.character);
            }
            document.getElementById('sheet-player-name').textContent = currentUserData.inGameName || 'Oyuncu';
            document.getElementById('sheet-player-level').textContent = `Seviye ${currentUserData.level || 1}`;
            const expPercentage = ((currentUserData.exp || 0) / (currentUserData.maxExp || 100)) * 100;
            document.getElementById('sheet-exp-bar').style.width = `${expPercentage}%`;
            document.getElementById('sheet-exp-text').textContent = `${currentUserData.exp || 0} / ${currentUserData.maxExp || 100}`;
            
            document.getElementById('derived-stats-display').innerHTML = `
                <div>❤️ Can: <span class="font-bold text-green-400">${calculated.hp.toFixed(0)}</span></div>
                <div>⚔️ Hasar: <span class="font-bold text-red-400">${calculated.damage.toFixed(1)}</span></div>
                <div>💧 Mana: <span class="font-bold text-blue-400">${calculated.mana.toFixed(0)}</span></div>
                <div>🛡️ Hasar Azaltma: <span class="font-bold text-gray-300">${calculated.damageReduction.toFixed(1)}%</span></div>
                <div>🍃 Kaçınma Şansı: <span class="font-bold text-teal-300">${calculated.dodgeChance.toFixed(1)}%</span></div>
                <div>💰 Market İndirimi: <span class="font-bold text-yellow-400">${calculated.marketDiscount.toFixed(1)}%</span></div>
                <div>⏱️ Seyahat Hızı: <span class="font-bold text-purple-400">${calculated.travelTimeReduction.toFixed(1)}%</span></div>
            `;
            const statPoints = currentUserData.statPoints || 0;
            document.getElementById('sheet-stat-points').textContent = statPoints;
            const statsContainer = document.getElementById('stats-container');
            statsContainer.innerHTML = '';
            const statNames = { guc: '💪 Güç', zeka: '🔮 Zeka', hiz: '🏹 Hız', tanklik: '🛡️ Tanklık' };
            for (const [stat, value] of Object.entries(stats)) {
                statsContainer.innerHTML += `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <button class="stat-info-btn" data-stat="${stat}">?</button>
                            <span class="font-semibold">${statNames[stat]}:</span>
                            <span class="text-lg text-white">${value}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="stat-plus-btn" data-stat="${stat}" ${statPoints === 0 ? 'disabled' : ''}>+</button>
                            <button class="stat-plus-btn hidden" data-stat="${stat}" data-amount="10" ${statPoints < 10 ? 'disabled' : ''}>+10</button>
                        </div>
                    </div>`;
            }

            // 2. ENVANTER VE EKİPMAN GÖSTERİMİ (YENİ VE BİRLEŞTİRİLMİŞ KISIM)
            const inventoryGrid = document.getElementById('character-inventory-grid');
            inventoryGrid.innerHTML = '';
            const playerInventory = currentUserData.inventory || [];
            playerInventory.forEach((item, index) => {
                if (item && GAME_ITEMS[item.id]) {
                    const itemData = GAME_ITEMS[item.id];
                    const slot = document.createElement('div');
                    slot.className = 'inventory-slot rounded-lg';
                    slot.innerHTML = itemData.icon;
                    slot.draggable = true;
                    slot.dataset.itemType = 'inventory';
                    slot.dataset.inventoryIndex = index;
                    slot.dataset.itemId = item.id;
                    
                    slot.addEventListener('mouseenter', () => showItemTooltip(item, slot)); // item.id yerine item
                    slot.addEventListener('mouseleave', hideItemTooltip);
                    inventoryGrid.appendChild(slot);
                }
            });
            for (let i = playerInventory.length; i < 30; i++) {
                const emptySlot = document.createElement('div');
                emptySlot.className = 'inventory-slot rounded-lg';
                inventoryGrid.appendChild(emptySlot);
            }

            const equipment = currentUserData.equipment || {};
            for (const slotKey of Object.keys(EQUIPMENT_SLOT_PLACEHOLDERS)) {
                 const slotId = `equip-slot-${slotKey}`;
                 const slotElement = document.getElementById(slotId);
                 if (!slotElement) continue;

                 const item = equipment[slotKey];
                 slotElement.innerHTML = ''; 
                 if (item && GAME_ITEMS[item.id]) {
                    slotElement.innerHTML = GAME_ITEMS[item.id].icon;
                    slotElement.draggable = true;
                    slotElement.dataset.itemType = 'equipment';
                    slotElement.dataset.slotKey = slotKey;
                    slotElement.dataset.itemId = item.id;

                    slotElement.addEventListener('mouseenter', () => showItemTooltip(item, slotElement)); // item.id yerine item
                    slotElement.addEventListener('mouseleave', hideItemTooltip);
                 } else {
                    // YENİ: BOŞ SLOTA PLACEHOLDER EKLEME
                    slotElement.innerHTML = EQUIPMENT_SLOT_PLACEHOLDERS[slotKey];
                    slotElement.draggable = false;
                    slotElement.removeAttribute('data-item-type');
                    slotElement.removeAttribute('data-slot-key');
                    slotElement.removeAttribute('data-item-id');
                 }
            }

            

        }

        // MARKET TRADE EKRANINI OLUŞTURMA (YENİ)
        function renderMarketTradeScreen() {
            const mainCategories = [...new Set(Object.values(GAME_ITEMS).map(item => item.category))].filter(category => category !== 'Canavar Parçası');
            mainCategories.push('Hızlı Sat');
            const mainTabsContainer = document.getElementById('market-category-tabs');
            const subTabsContainer = document.getElementById('market-subcategory-tabs');
            const marketItemList = document.getElementById('market-item-list');
            mainTabsContainer.innerHTML = '';

            mainCategories.forEach(category => {
                const button = document.createElement('button');
                button.textContent = category;
                button.className = 'market-category-btn px-4 py-2 rounded-md font-semibold text-gray-300';
                if (category === currentMarketCategory) { button.classList.add('active'); }
                
                button.addEventListener('click', () => {
                    currentMarketCategory = category;
                    mainTabsContainer.querySelectorAll('.market-category-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');

                    // --- DÜZELTME BURADA ---
                    // Önce her iki ekranı da kontrol et ve gizle
                    marketQuickSellScreen.classList.add('hidden');
                    marketTradeScreen.classList.add('hidden');

                    if (category === 'Hızlı Sat') {
                        subTabsContainer.classList.add('hidden');
                        marketQuickSellScreen.classList.remove('hidden'); // Sadece Hızlı Sat ekranını göster
                        renderQuickSellScreen();
                        return;
                    }
                    
                    // Diğer tüm kategoriler için normal market ekranını göster
                    marketTradeScreen.classList.remove('hidden'); 

                    if (SUB_CATEGORIES[category]) {
                        subTabsContainer.innerHTML = '';
                        subTabsContainer.classList.remove('hidden');
                        currentMarketSubCategory = SUB_CATEGORIES[category][0]; 

                        SUB_CATEGORIES[category].forEach(subCategory => {
                            const subButton = document.createElement('button');
                            subButton.textContent = subCategory;
                            subButton.className = 'market-category-btn px-3 py-1 rounded-md text-sm font-semibold text-gray-400';
                            if (subCategory === currentMarketSubCategory) { subButton.classList.add('active'); }
                            
                            subButton.addEventListener('click', () => {
                                currentMarketSubCategory = subCategory;
                                subTabsContainer.querySelectorAll('.market-category-btn').forEach(btn => btn.classList.remove('active'));
                                subButton.classList.add('active');
                                renderMarketItems();
                            });
                            subTabsContainer.appendChild(subButton);
                        });
                    } else {
                        subTabsContainer.classList.add('hidden');
                        currentMarketSubCategory = null;
                    }
                    
                    renderMarketItems();
                });
                mainTabsContainer.appendChild(button);
            });
            
            if (SUB_CATEGORIES[currentMarketCategory]) {
                mainTabsContainer.querySelector('.active').dispatchEvent(new Event('click'));
            } else if (currentMarketCategory !== 'Hızlı Sat') {
                 renderMarketItems();
            }
        }

        // MARKET EŞYALARINI LİSTELEME (YENİ)
        function renderMarketItems() {
             if (!currentUserData) return;
            const itemListContainer = document.getElementById('market-item-list');
            itemListContainer.innerHTML = '';
            const playerInventoryCounts = currentUserData.inventory.reduce((acc, item) => {
                acc[item.id] = (acc[item.id] || 0) + 1;
                return acc;
            }, {});

            for (const [id, item] of Object.entries(GAME_ITEMS)) {
                if (item.buyPrice > 0 && (item.baseRarity === 'common' || item.baseRarity === 'rare')) {
                    const categoryMatch = item.category === currentMarketCategory;
                    let subCategoryMatch = true; 
                    
                    if (currentMarketSubCategory) {
                        subCategoryMatch = item.subCategory === currentMarketSubCategory;
                    }

                    if (categoryMatch && subCategoryMatch) {
                        const rarity = RARITY_CONFIG[item.baseRarity] || RARITY_CONFIG.common;
                        const itemElement = document.createElement('div');
                        itemElement.className = 'market-item rounded-lg p-4 flex items-center justify-between gap-4';
                        
                        // "Sat" butonu HTML'den kaldırıldı.
                        itemElement.innerHTML = `
                            <div class="rarity-border" style="background: ${rarity.color}; opacity: 0.4;"></div>
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 flex-shrink-0 bg-gray-900/50 rounded-md flex items-center justify-center">${item.icon}</div>
                                <div>
                                    <h4 class="font-bold" style="color: ${rarity.color};">${item.name}</h4>
                                    <p class="text-xs text-gray-400">Envanterde: ${playerInventoryCounts[id] || 0}</p>
                                </div>
                            </div>
                            <div class="flex flex-col items-end">
                                <button data-item-id="${id}" class="buy-item-btn bg-green-600 hover:bg-green-500 text-white font-bold py-1 px-3 rounded-md text-sm transition w-24">Al: ${item.buyPrice}💰</button>
                            </div>
                        `;

                        const itemInstance = { id: id, rarity: item.baseRarity };
                        itemElement.addEventListener('mouseenter', () => showItemTooltip(itemInstance, itemElement));
                        itemElement.addEventListener('mouseleave', hideItemTooltip);
                        itemListContainer.appendChild(itemElement);
                    }
                }
            }
        }
        
        // EŞYA ALIM/SATIM İŞLEMLERİ (YENİ)
        async function buyItem(itemId) {
            const item = GAME_ITEMS[itemId];
            if (!item || !currentUserData || currentUserData.gold < item.buyPrice) {
                console.log("Yetersiz altın veya geçersiz eşya.");
                return;
            }
            const userRef = doc(db, "users", auth.currentUser.uid);
            // ARTIK NADİRLİK BİLGİSİYLE KAYDEDİYORUZ
            const newItemObject = {
                id: itemId,
                rarity: item.baseRarity 
            };
            try {
                await updateDoc(userRef, {
                    gold: increment(-item.buyPrice),
                    inventory: arrayUnion(newItemObject)
                });
                console.log(`${item.name} satın alındı.`);
            } catch (error) {
                console.error("Eşya alımında hata:", error);
            }
        }

        async function sellItem(itemId) {
            const item = GAME_ITEMS[itemId];
            if (!item) return;

            const userRef = doc(db, "users", auth.currentUser.uid);

            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) {
                        throw "Kullanıcı bulunamadı!";
                    }
                    const userData = userDoc.data();
                    const inventory = userData.inventory || [];
                    
                    const itemIndex = inventory.findIndex(invItem => invItem.id === itemId);

                    if (itemIndex > -1) {
                        inventory.splice(itemIndex, 1); // Eşyayı envanterden kaldır
                        transaction.update(userRef, {
                            inventory: inventory,
                            gold: increment(item.sellPrice)
                        });
                    } else {
                        throw "Satılacak eşya envanterde yok.";
                    }
                });
                console.log(`${item.name} satıldı.`);
            } catch (error) {
                console.error("Eşya satımında hata: ", error);
            }
        }

        async function equipItem(inventoryIndex) {
            const itemToEquip = currentUserData.inventory[inventoryIndex];
            if (!itemToEquip) return;
            
            const itemData = GAME_ITEMS[itemToEquip.id];
            if (currentUserData.level < itemData.requiredLevel) {
                alert(`Bu eşyayı giymek için ${itemData.requiredLevel}. seviye olmalısın!`);
                return;
            }

            const userRef = doc(db, "users", auth.currentUser.uid);
            
            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) throw "Kullanıcı bulunamadı!";
                    
                    let data = userDoc.data();
                    let inventory = [...data.inventory];
                    let equipment = data.equipment || { weapon: null, helmet: null, chest: null, pants: null, boots: null, gloves: null, necklace: null, bracelet: null, earring: null, belt: null };

                    // ---- GÜNCELLENEN MANTIK BURADA ----
                    let slotKey;
                    if (itemData.category === 'Silah') {
                        slotKey = 'weapon'; // Tüm silah alt kategorileri 'weapon' slotuna gider.
                    } else {
                        const slotType = itemData.subCategory;
                        slotKey = SLOT_TYPE_TO_KEY_MAP[slotType];
                    }
                    // ---- GÜNCELLEME SONU ----

                    if (!slotKey) throw "Bu eşya giyilemez.";

                    const currentlyEquippedItem = equipment[slotKey];
                    if (currentlyEquippedItem) {
                        inventory.push(currentlyEquippedItem);
                    }

                    inventory.splice(inventoryIndex, 1);
                    equipment[slotKey] = itemToEquip;

                    transaction.update(userRef, { inventory, equipment });
                });
            } catch (error) {
                console.error("Ekipman giyme hatası:", error);
                alert("Ekipman giyerken bir hata oluştu.");
            }
        }

        async function unequipItem(slotKey) {
            const userRef = doc(db, "users", auth.currentUser.uid);

            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) throw "Kullanıcı bulunamadı!";

                    let data = userDoc.data();
                    let inventory = [...data.inventory];
                    let equipment = data.equipment;

                    if (!equipment || !equipment[slotKey]) throw "Bu slotta zaten eşya yok.";
                    
                    const itemToUnequip = equipment[slotKey];
                    
                    // Eşyayı envantere ekle
                    inventory.push(itemToUnequip);
                    
                    // Slottan eşyayı kaldır
                    equipment[slotKey] = null;

                    transaction.update(userRef, { inventory, equipment });
                });
            } catch (error) {
                console.error("Ekipman çıkarma hatası:", error);
            }
        }


        document.getElementById('market-item-list').addEventListener('click', (e) => {
            const buyButton = e.target.closest('.buy-item-btn');
            if (buyButton) {
                buyItem(buyButton.dataset.itemId);
                return;
            }
            const sellButton = e.target.closest('.sell-item-btn');
            if (sellButton) {
                sellItem(sellButton.dataset.itemId);
            }
        });


        function renderChestUI() {
            if (!currentUserData) return;

            chestPageButtons.forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.page) === currentChestPage);
            });
            
            // *** YENİLENEN BÖLÜM BAŞLANGICI ***
            chestPlayerInventory.innerHTML = '';
            const playerInventory = currentUserData.inventory || [];
            for (let i = 0; i < 30; i++) {
                const item = playerInventory[i];
                const slot = document.createElement('div');
                slot.className = 'inventory-slot rounded-lg flex items-center justify-center text-xs p-1 text-center';
                
                if (item && GAME_ITEMS[item.id]) {
                    const itemData = GAME_ITEMS[item.id];
                    slot.innerHTML = itemData.icon;
                    // EKSİK OLAN TOOLTIP OLAYLARI BURAYA EKLENDİ
                    slot.addEventListener('mouseenter', () => showItemTooltip(item, slot));
                    slot.addEventListener('mouseleave', hideItemTooltip);
                }
                chestPlayerInventory.appendChild(slot);
            }
            // *** YENİLENEN BÖLÜM SONU ***

            chestHouseInventory.innerHTML = '';
            const houseInventory = (currentUserData.houseInventory && currentUserData.houseInventory.length === 60)
                ? currentUserData.houseInventory
                : Array(60).fill(null);

            const pageStartIndex = (currentChestPage - 1) * 30;
            for (let i = 0; i < 30; i++) {
                const itemIndex = pageStartIndex + i;
                const item = houseInventory[itemIndex];
                const slot = document.createElement('div');
                slot.className = 'inventory-slot rounded-lg flex items-center justify-center text-xs p-1 text-center';
                if (item) {
                    slot.textContent = item.name;
                }
                chestHouseInventory.appendChild(slot);
            }
        }

        function initPriceChart() {
            const ctx = document.getElementById('price-chart').getContext('2d');
            if (priceChart) {
                priceChart.destroy();
            }
            
            const initialLabels = Array.from({length: 20}, (_, i) => `${19 - i}dk önce`);

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: initialLabels,
                    datasets: [{
                        label: 'Elma Şarabı',
                        data: Array.from({length: 20}, () => 110 + Math.random() * 20),
                        borderColor: 'rgba(251, 191, 36, 0.8)',
                        backgroundColor: 'rgba(251, 191, 36, 0.2)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 2,
                        fill: true
                    }, {
                        label: 'Üzüm Şarabı',
                        data: Array.from({length: 20}, () => 240 + Math.random() * 30),
                        borderColor: 'rgba(192, 132, 252, 0.8)',
                        backgroundColor: 'rgba(192, 132, 252, 0.2)',
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 2,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: 'white' }
                        },
                        title: {
                            display: true,
                            text: 'Anlık Fiyat Değişimi',
                            color: 'white',
                            font: { size: 16 }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += `${Math.round(context.parsed.y)} 💰`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Fiyat (💰)',
                                color: 'rgba(255,255,255,0.8)'
                            },
                            ticks: {
                                color: 'rgba(255,255,255,0.7)',
                                callback: function(value) { return value + ' 💰'; }
                            },
                            grid: { color: 'rgba(255,255,255,0.2)' }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Zaman',
                                color: 'rgba(255,255,255,0.8)'
                            },
                            ticks: {
                                color: 'rgba(255,255,255,0.7)',
                                autoSkip: true,
                                maxTicksLimit: 8
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });

            if (priceUpdateInterval) clearInterval(priceUpdateInterval);
            priceUpdateInterval = setInterval(updatePrices, 60000); // Update every minute
        }

        function updatePrices() {
            if (!priceChart) return;

            const timeLabel = new Date().toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
            priceChart.data.labels.push(timeLabel);
            priceChart.data.labels.shift();

            priceChart.data.datasets.forEach((dataset, index) => {
                const lastValue = dataset.data[dataset.data.length - 1];
                const baseValue = index === 0 ? 120 : 250;
                const volatility = index === 0 ? 10 : 20;
                let newValue = lastValue + (Math.random() - 0.5) * volatility;
                if (newValue < baseValue * 0.8) newValue = baseValue * 0.8;
                if (newValue > baseValue * 1.2) newValue = baseValue * 1.2;
                
                dataset.data.push(newValue);
                dataset.data.shift();
                
                const priceElementId = index === 0 ? 'apple-wine-price' : 'grape-wine-price';
                const priceElement = document.getElementById(priceElementId);
                if (priceElement) {
                     priceElement.textContent = `${Math.round(newValue)} 💰`;
                }
            });
            priceChart.update();
        }

        function showItemTooltip(itemInstance, element) {
            clearTimeout(hideTooltipTimeout); // << ÖNCEKİ GİZLEME ZAMANLAYICISINI İPTAL ET
            const itemData = GAME_ITEMS[itemInstance.id];
            if (!itemData) return;

            const rarity = RARITY_CONFIG[itemInstance.rarity] || RARITY_CONFIG.common;
            
            let statsHtml = '';
            if (itemData.stats) {
                statsHtml += '<div class="border-t border-gray-700 mt-2 pt-2 space-y-1">';
                for (const [stat, value] of Object.entries(itemData.stats)) {
                    statsHtml += `<p class="text-green-400 capitalize">${stat.replace(/([A-Z])/g, ' $1')}: +${value}</p>`;
                }
                statsHtml += '</div>';
            }

            let levelReqHtml = '';
            if (itemData.requiredLevel > 1) {
                const canEquip = currentUserData.level >= itemData.requiredLevel;
                levelReqHtml = `<p class="mt-2 ${canEquip ? 'text-gray-400' : 'text-red-500'}">Gerekli Seviye: ${itemData.requiredLevel}</p>`;
            }

            itemTooltip.innerHTML = `
                <h4 class="font-bold text-lg" style="color: ${rarity.color};">${itemData.name}</h4>
                <p class="text-sm" style="color: ${rarity.color};">${rarity.name} ${itemData.subCategory || itemData.category}</p>
                ${statsHtml}
                <div class="border-t border-gray-700 mt-2 pt-2">
                    <p class="text-yellow-400">Satış Fiyatı: ${itemData.sellPrice} 💰</p>
                </div>
                ${levelReqHtml}
            `;
            
            const rect = element.getBoundingClientRect();
            itemTooltip.style.left = `${rect.right + 10}px`;
            itemTooltip.style.top = `${rect.top}px`;
            
            itemTooltip.classList.remove('hidden');
            setTimeout(() => itemTooltip.classList.add('visible'), 10);
        }

        function hideItemTooltip() {
            // Zamanlayıcıyı değişkene ata
            hideTooltipTimeout = setTimeout(() => {
                itemTooltip.classList.remove('visible');
                // Animasyonun bitmesi için ek bir gecikme sonrası gizle
                setTimeout(() => itemTooltip.classList.add('hidden'), 200);
            }, 200); // 200ms bekle sonra gizle
        }

        function handleUserLogin(user) {
             if (!user) return;
             
             // Eğer daha önceden kalan bir dinleyici varsa temizle
             if (unsubscribeUser) unsubscribeUser();

             unsubscribeUser = onSnapshot(doc(db, "users", user.uid), (docSnap) => {
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    
                    // Sadece ilk yüklemede veya karakteri yoksa ekran değiştir.
                    if (isInitialLoad) {
                        if (currentUserData.characterCreated && !isResettingCharacter) {
                            userDisplay.textContent = currentUserData.inGameName || currentUserData.username;
                            uidDisplay.textContent = user.uid;
                            showScreen(mainMenuScreen); // SADECE İLK SEFERDE ANA MENÜYÜ GÖSTER
                        } else {
                            setupCharacterCreation();
                            showScreen(characterCreationScreen);
                        }
                        isInitialLoad = false; // Sonraki güncellemeler için bayrağı kapat
                    }
                    
                    // Sonraki tüm güncellemelerde, ekranı değiştirmek yerine SADECE ARAYÜZÜ YENİLE.
                    // Karakter sayfası açıksa onu güncelle
                    if (!characterSheetModal.classList.contains('hidden')) {
                        updateCharacterSheetUI();
                    }
                    // Market ekranı açıksa onu güncelle (özellikle envanter sayısı için)
                    if (!marketTradeScreen.classList.contains('hidden')) {
                       renderMarketItems();
                    }
                    // Hızlı Sat ekranı açıksa onu güncelle
                    if(!marketQuickSellScreen.classList.contains('hidden')) {
                        renderQuickSellScreen();
                    }
                    
                    // Her zaman görünen global UI elemanlarını güncelle
                    document.getElementById('gold-display').textContent = Math.floor(currentUserData.gold) || 0;
                    document.getElementById('diamond-display').textContent = currentUserData.diamonds || 0;
                    if(currentUserData.character) {
                        updateCharacterPreview('profile-character-preview', currentUserData.character);
                    }
                }
             });
        }
        
        onAuthStateChanged(auth, (user) => {
            if (user) { handleUserLogin(user); } 
            else {
                showScreen(authScreen);
                if (unsubscribeUser) unsubscribeUser();
                currentUserData = null;
            }
        });

        const createUserDocument = async (user) => {
            if (!user) return;
            const userRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userRef);
            if (!userSnap.exists()) {
                const username = user.displayName || user.email.split('@')[0];
                await setDoc(userRef, {
                    username, email: user.email, uid: user.uid, createdAt: new Date(),
                    characterCreated: false,
                    gold: 1000, 
                    diamonds: 200,
                    fame: 1000,
                    energy: 100,
                    maxEnergy: 100,
                    inventory: [],
                    houseInventory: Array(60).fill(null), // Initialize house inventory
                    usedCodes: [],
                    equipment: {
                        weapon: null, helmet: null, chest: null, pants: null, 
                        boots: null, gloves: null, necklace: null, bracelet: null, 
                        earring: null, belt: null
                    }
                });
            }
        };
        
        window.addEventListener('mousemove', (e) => {
            let activeScreen = !characterCreationScreen.classList.contains('hidden') ? 'character-creation-screen' : !characterSheetModal.classList.contains('hidden') ? 'character-sheet-modal' : null;
            if (!activeScreen) return;
            const svgId = activeScreen === 'character-creation-screen' ? 'character-preview' : 'sheet-character-preview';
            const head = document.querySelector(`#${svgId} #head-group`)?.getBoundingClientRect();
            if(!head) return;
            const pupilsToMove = document.querySelectorAll(`#${svgId} #pupil-left, #${svgId} #pupil-right`);
            pupilsToMove.forEach((pupil, i) => {
                const eyeX = head.left + (eyeOrigins[i].x - 60) * (head.width / 80), eyeY = head.top + (eyeOrigins[i].y - 25) * (head.height / 90);
                const angle = Math.atan2(e.clientY - eyeY, e.clientX - eyeX);
                pupil.setAttribute('cx', eyeOrigins[i].x + Math.cos(angle) * maxMove);
                pupil.setAttribute('cy', eyeOrigins[i].y + Math.sin(angle) * maxMove);
            });
        });
        
        function hideStatTooltip() {
            statTooltip.classList.add('opacity-0', 'hidden');
            window.removeEventListener('click', hideStatTooltip, true);
        }

        document.getElementById('stats-container').addEventListener('click', (e) => {
            const infoBtn = e.target.closest('.stat-info-btn');
            if (infoBtn) {
                e.stopPropagation();
                hideStatTooltip();
                const stat = infoBtn.dataset.stat;
                statTooltip.innerHTML = STAT_DESCRIPTIONS[stat];
                const rect = infoBtn.getBoundingClientRect();
                statTooltip.style.left = `${rect.right + 10}px`;
                statTooltip.style.top = `${rect.top}px`;
                statTooltip.classList.remove('hidden');
                setTimeout(() => statTooltip.classList.remove('opacity-0'), 10);
                setTimeout(() => window.addEventListener('click', hideStatTooltip, true), 0);
                return;
            }
            const plusBtn = e.target.closest('.stat-plus-btn');
            if (plusBtn) {
                 const stat = plusBtn.dataset.stat;
                const amount = parseInt(plusBtn.dataset.amount) || 1;
                incrementStat(stat, amount);
                if (amount === 1) {
                    const now = Date.now();
                    const tracker = statClickTracker[stat] || { count: 0, lastClick: 0 };
                    if (now - tracker.lastClick < 400) { tracker.count++; } 
                    else { tracker.count = 1; }
                    tracker.lastClick = now;
                    statClickTracker[stat] = tracker;
                    if (tracker.count >= 3) {
                        const plus10Button = plusBtn.nextElementSibling;
                        if (plus10Button && currentUserData.statPoints >= 10) {
                            plus10Button.classList.remove('hidden');
                            setTimeout(() => plus10Button.classList.add('hidden'), 3000);
                        }
                        tracker.count = 0;
                    }
                }
            }
        });
        
        async function incrementStat(stat, amount) {
            const user = auth.currentUser;
            if (!user || !currentUserData || currentUserData.statPoints < amount) return;
            const userRef = doc(db, "users", user.uid);
            try {
                const statKey = `stats.${stat}`;
                await updateDoc(userRef, {
                    [statKey]: increment(amount),
                    statPoints: increment(-amount)
                });
            } catch (error) {
                console.error("Stat güncellenirken hata:", error);
            }
        }

        startGameBtn.addEventListener('click', () => showScreen(gameScreen));
        playerProfileButton.addEventListener('click', () => {
            updateCharacterSheetUI();
            characterSheetModal.classList.remove('hidden');
            setTimeout(() => characterSheetModal.classList.remove('modal-closed'), 10); 
        });
        closeCharacterSheetButton.addEventListener('click', () => {
            characterSheetModal.classList.add('modal-closed');
            setTimeout(() => characterSheetModal.classList.add('hidden'), 300); 
        });
        globalSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        closeSettingsModalBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));
        logoutBtn.addEventListener('click', () => {
            signOut(auth);
            settingsModal.classList.add('hidden');
            isInitialLoad = true; // << YENİ EKLENEN SATIR
        });
        loginTabBtn.addEventListener('click', () => {
            loginTabBtn.classList.add('active');
            registerTabBtn.classList.remove('active');
            loginForm.classList.remove('hidden');
            registerForm.classList.add('hidden');
            authMessage.textContent = "";
        });
        registerTabBtn.addEventListener('click', () => {
            registerTabBtn.classList.add('active');
            loginTabBtn.classList.remove('active');
            registerForm.classList.remove('hidden');
            loginForm.classList.add('hidden');
            authMessage.textContent = "";
        });
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            const email = `${username}@oyun.local`;
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    authMessage.textContent = "Kayıt başarılı! Yönlendiriliyor...";
                    authMessage.style.color = 'lightgreen';
                    createUserDocument(userCredential.user);
                })
                .catch((error) => {
                    if (error.code === 'auth/email-already-in-use') authMessage.textContent = "Bu kullanıcı adı zaten kullanılıyor.";
                    else if (error.code === 'auth/weak-password') authMessage.textContent = "Şifre en az 6 karakter olmalı.";
                    else authMessage.textContent = "Kayıt sırasında bir hata oluştu.";
                });
        });
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const email = `${username}@oyun.local`;
            signInWithEmailAndPassword(auth, email, password)
                .catch(() => { authMessage.textContent = "Kullanıcı adı veya şifre hatalı."; });
        });
        googleSignInBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then(async (result) => await createUserDocument(result.user))
                .catch((error) => { 
                    console.error("Google giriş hatası:", error);
                    authMessage.textContent = "Google ile giriş yapılamadı."; 
                });
        });
        homeButton.addEventListener('click', () => showGameSubScreen(homeScreen));
        arenaButton.addEventListener('click', () => showGameSubScreen(arenaScreen));
        marketButton.addEventListener('click', () => showGameSubScreen(marketScreen));
        goToGarageBtn.addEventListener('click', () => showGameSubScreen(garageScreen));
        goToGardenBtn.addEventListener('click', () => showGameSubScreen(gardenScreen));
        goToBasementBtn.addEventListener('click', () => showGameSubScreen(basementScreen));
        document.querySelectorAll('.back-to-village-button').forEach(button => {
            button.addEventListener('click', () => {
                showVillageView();
                if(priceUpdateInterval) clearInterval(priceUpdateInterval);
            });
        });
        document.querySelectorAll('.back-to-home-button').forEach(button => {
            button.addEventListener('click', () => showGameSubScreen(homeScreen));
        });
        showLeaguesButton.addEventListener('click', () => { arenaMainView.classList.add('hidden'); leaguesScreen.classList.remove('hidden'); });
        showDungeonsButton.addEventListener('click', () => { arenaMainView.classList.add('hidden'); dungeonsScreen.classList.remove('hidden'); });
        document.querySelectorAll('.back-to-arena-button').forEach(b => b.addEventListener('click', () => {
            leaguesScreen.classList.add('hidden');
            dungeonsScreen.classList.add('hidden');
            arenaMainView.classList.remove('hidden');
        }));
        showMarketBuyButton.addEventListener('click', () => { marketMainView.classList.add('hidden'); marketBuyScreen.classList.remove('hidden'); });
        showMarketSellButton.addEventListener('click', () => { 
            marketMainView.classList.add('hidden'); 
            marketSellScreen.classList.remove('hidden'); 
            initPriceChart();
        });
        showMarketTradeButton.addEventListener('click', () => { 
            marketMainView.classList.add('hidden'); 
            marketTradeScreen.classList.remove('hidden');
            currentMarketCategory = 'Silah'; // Varsayılan kategoriyi ayarla
            renderMarketTradeScreen();
        });
        document.querySelectorAll('.back-to-market-button').forEach(b => b.addEventListener('click', () => {
            marketBuyScreen.classList.add('hidden');
            marketSellScreen.classList.add('hidden');
            marketTradeScreen.classList.add('hidden');
            marketQuickSellScreen.classList.add('hidden'); // << EKLENEN YENİ SATIR
            marketMainView.classList.remove('hidden');
            if(priceUpdateInterval) clearInterval(priceUpdateInterval);
        }));

        // Basement Menu Logic
        openBasementMenuBtn.addEventListener('click', () => showGameSubScreen(basementMenuScreen));
        closeBasementMenuBtn.addEventListener('click', () => showGameSubScreen(basementScreen));
        showDevelopmentsBtn.addEventListener('click', () => showGameSubScreen(developmentsScreen));
        showEmployeesBtn.addEventListener('click', () => showGameSubScreen(employeesScreen));
        backToBasementMenuBtns.forEach(btn => btn.addEventListener('click', () => showGameSubScreen(basementMenuScreen)));


        redeemCodeButton.addEventListener('click', async () => {
            const codeInput = document.getElementById('gift-code-input');
            const code = codeInput.value.trim();
            const user = auth.currentUser;
            if (!code || !user) return;
            giftCodeMessage.textContent = "";
            if (code === "MusTea200") {
                if (currentUserData.usedCodes && currentUserData.usedCodes.includes("MusTea200")) {
                    giftCodeMessage.textContent = "Bu kod zaten kullanılmış.";
                    giftCodeMessage.style.color = "orange";
                    return;
                }
                const userRef = doc(db, "users", user.uid);
                const stick = { id: `stick_${Date.now()}`, name: "Sopa", type: "weapon", rarity: "common", stats: { hp: 20, guc: 5 } };
                try {
                    await updateDoc(userRef, {
                        gold: increment(1000),
                        diamonds: increment(200),
                        inventory: arrayUnion(stick),
                        usedCodes: arrayUnion("MusTea200")
                    });
                    giftCodeMessage.textContent = "Ödüller eklendi!";
                    giftCodeMessage.style.color = "lightgreen";
                    codeInput.value = "";
                } catch(e) {
                     giftCodeMessage.textContent = "Bir hata oluştu.";
                     giftCodeMessage.style.color = "red";
                }
            } else {
                giftCodeMessage.textContent = "Geçersiz kod.";
                giftCodeMessage.style.color = "red";
            }
        });

        function setupCharacterCreation() {
            const skinContainer = document.getElementById('skin-color-swatches');
            const hairContainer = document.getElementById('hair-color-swatches');
            skinContainer.innerHTML = '';
            hairContainer.innerHTML = '';
            skinColors.forEach((color, index) => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                if (index === 1) swatch.classList.add('selected');
                swatch.style.backgroundColor = color;
                swatch.addEventListener('click', () => {
                    selectedSkinColor = color;
                    document.querySelectorAll('#character-creation-screen .character-skin-part').forEach(part => part.style.fill = color);
                    skinContainer.querySelector('.selected')?.classList.remove('selected');
                    swatch.classList.add('selected');
                });
                skinContainer.appendChild(swatch);
            });
            hairColors.forEach((color, index) => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                if (index === 1) swatch.classList.add('selected');
                swatch.style.backgroundColor = color;
                swatch.addEventListener('click', () => {
                    selectedHairColor = color;
                    ['#hair-male', '#hair-female-front', '#hair-female-back'].forEach(id => {
                        const el = document.querySelector(`#character-creation-screen ${id}`);
                        if (el) el.style.fill = color;
                    });
                    hairContainer.querySelector('.selected')?.classList.remove('selected');
                    swatch.classList.add('selected');
                });
                hairContainer.appendChild(swatch);
            });
            document.querySelectorAll('.gender-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    selectedGender = e.target.dataset.gender;
                    document.querySelector('.gender-btn.active').classList.remove('active');
                    e.target.classList.add('active');
                    const isMale = selectedGender === 'male';
                    ['#body-male', '#hair-male-front-group'].forEach(id => document.querySelector(`#character-creation-screen ${id}`).classList.toggle('hidden', !isMale));
                    ['#body-female', '#hair-female-front-group', '#hair-female-back-group'].forEach(id => document.querySelector(`#character-creation-screen ${id}`).classList.toggle('hidden', isMale));
                });
            });
            if (currentUserData && currentUserData.inGameName) {
                document.getElementById('in-game-name-container').classList.add('hidden');
                document.getElementById('in-game-name-display').classList.remove('hidden');
                document.getElementById('locked-in-game-name').textContent = currentUserData.inGameName;
            } else {
                document.getElementById('in-game-name-container').classList.remove('hidden');
                document.getElementById('in-game-name-display').classList.add('hidden');
            }
            ['#body-male', '#hair-male-front-group'].forEach(id => document.querySelector(`#character-creation-screen ${id}`).classList.remove('hidden'));
            ['#body-female', '#hair-female-front-group', '#hair-female-back-group'].forEach(id => document.querySelector(`#character-creation-screen ${id}`).classList.add('hidden'));
            if(isResettingCharacter) {
                resetCharWarning.textContent = "Karakterini yeniden tasarla! (100💎)";
                createCharacterBtn.disabled = currentUserData && currentUserData.diamonds < 100;
                if (createCharacterBtn.disabled) resetCharWarning.textContent = "Yeterli elmas yok! (100💎 gerekli)";
            } else {
                createCharacterBtn.disabled = false;
                resetCharWarning.textContent = "";
            }
        }
        function setupWardrobeScreen() {
            if (!currentUserData || !currentUserData.character) return;

            // 1. Mevcut görünüm bilgilerini al ve sakla
            const { gender, skinColor, hairColor } = currentUserData.character;
            selectedWardrobeGender = gender;
            selectedWardrobeSkinColor = skinColor;
            selectedWardrobeHairColor = hairColor;

            // 2. Karakter önizlemesini güncelle
            updateCharacterPreview('wardrobe-character-preview', currentUserData.character);

            // 3. Cinsiyet butonlarını ayarla
            const genderButtons = document.getElementById('wardrobe-gender-buttons');
            genderButtons.querySelector('.active')?.classList.remove('active');
            genderButtons.querySelector(`[data-gender="${gender}"]`).classList.add('active');

            // 4. Renk paletlerini oluştur ve mevcut renkleri seç
            const skinContainer = document.getElementById('wardrobe-skin-color-swatches');
            skinContainer.innerHTML = '';
            skinColors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                if (color === skinColor) swatch.classList.add('selected');
                swatch.style.backgroundColor = color;
                swatch.addEventListener('click', () => {
                    selectedWardrobeSkinColor = color;
                    skinContainer.querySelector('.selected')?.classList.remove('selected');
                    swatch.classList.add('selected');
                    updateCharacterPreview('wardrobe-character-preview', { gender: selectedWardrobeGender, skinColor: selectedWardrobeSkinColor, hairColor: selectedWardrobeHairColor });
                });
                skinContainer.appendChild(swatch);
            });

            const hairContainer = document.getElementById('wardrobe-hair-color-swatches');
            hairContainer.innerHTML = '';
            hairColors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                if (color === hairColor) swatch.classList.add('selected');
                swatch.style.backgroundColor = color;
                swatch.addEventListener('click', () => {
                    selectedWardrobeHairColor = color;
                    hairContainer.querySelector('.selected')?.classList.remove('selected');
                    swatch.classList.add('selected');
                    updateCharacterPreview('wardrobe-character-preview', { gender: selectedWardrobeGender, skinColor: selectedWardrobeSkinColor, hairColor: selectedWardrobeHairColor });
                });
                hairContainer.appendChild(swatch);
            });
            
            // Cinsiyet butonlarının tıklama olayları
            genderButtons.querySelectorAll('.gender-btn').forEach(btn => {
                btn.onclick = (e) => { // onclick kullanarak eski listener'ların üzerine yazıyoruz
                    selectedWardrobeGender = e.target.dataset.gender;
                    genderButtons.querySelector('.active').classList.remove('active');
                    e.target.classList.add('active');
                    updateCharacterPreview('wardrobe-character-preview', { gender: selectedWardrobeGender, skinColor: selectedWardrobeSkinColor, hairColor: selectedWardrobeHairColor });
                };
            });

            // 5. Elmas kontrolü yap ve butonu etkinleştir/devre dışı bırak
            confirmWardrobeChangeButton.disabled = currentUserData.diamonds < 100;
        }

        async function applyWardrobeChange() {
            if (currentUserData.diamonds < 100) {
                alert("Görünümünü değiştirmek için yeterli elmasın yok! (100 💎 gerekli)");
                return;
            }
            
            confirmWardrobeChangeButton.disabled = true; // Tekrar tıklamayı önle
            const userRef = doc(db, "users", auth.currentUser.uid);

            try {
                await updateDoc(userRef, {
                    'character.gender': selectedWardrobeGender,
                    'character.skinColor': selectedWardrobeSkinColor,
                    'character.hairColor': selectedWardrobeHairColor,
                    diamonds: increment(-100)
                });
                alert("Görünümün başarıyla değiştirildi!");
                showGameSubScreen(homeScreen); // Eve geri dön
            } catch (error) {
                console.error("Görünüm değiştirme hatası:", error);
                alert("Bir hata oluştu, değişiklikler kaydedilemedi.");
            } finally {
                confirmWardrobeChangeButton.disabled = false; // İşlem bitince butonu tekrar aktif et
            }
        }
        
        characterCreationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            createCharacterBtn.disabled = true; 
            nameValidationMessage.textContent = ''; 
            const user = auth.currentUser;
            if (!user) { createCharacterBtn.disabled = false; return; }
            const inGameName = document.getElementById('character-name-input').value.trim();
            const nameRegex = /^[a-zA-Z0-9öçşığüÖÇŞİĞÜ]+$/;
            if (!currentUserData.inGameName && (inGameName.length < 3 || !nameRegex.test(inGameName))) {
                nameValidationMessage.textContent = inGameName.length < 3 ? "İsim en az 3 karakter olmalı." : "İsim özel karakter içeremez.";
                createCharacterBtn.disabled = false;
                return;
            }
            try {
                await runTransaction(db, async (transaction) => {
                    const userRef = doc(db, "users", user.uid);
                    let updateData = {
                        character: { gender: selectedGender, skinColor: selectedSkinColor, hairColor: selectedHairColor },
                        characterCreated: true,
                        level: 1, exp: 0, maxExp: 100, statPoints: 5,
                        stats: { guc: 1, zeka: 1, hiz: 1, tanklik: 1 },
                        fame: 1000, energy: 100, maxEnergy: 100, inventory: [], houseInventory: Array(60).fill(null), usedCodes: []
                    };
                    if (!currentUserData.inGameName) {
                        const lowercaseName = inGameName.toLowerCase();
                        const usernameRef = doc(db, "usernames", lowercaseName);
                        const usernameDoc = await transaction.get(usernameRef);
                        if (usernameDoc.exists()) throw new Error("Bu oyun içi isim zaten alınmış.");
                        transaction.set(usernameRef, { uid: user.uid });
                        updateData.inGameName = inGameName;
                    }
                    if(isResettingCharacter) {
                        const freshUserData = await transaction.get(userRef);
                        if (freshUserData.data().diamonds < 100) throw new Error("Yeterli elmasın yok!");
                        updateData.diamonds = freshUserData.data().diamonds - 100;
                    }
                    transaction.update(userRef, updateData);
                });
                isResettingCharacter = false;
                resetCharWarning.textContent = "";
            } catch (error) {
                nameValidationMessage.textContent = error.message;
                createCharacterBtn.disabled = false; 
            }
        });

        // Event Listeners for Chest
        openChestButton.addEventListener('click', () => {
            currentChestPage = 1;
            renderChestUI();
            chestModal.classList.remove('hidden');
        });
        closeChestButton.addEventListener('click', () => {
            chestModal.classList.add('hidden');
        });
        chestPageButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentChestPage = parseInt(button.dataset.page);
                renderChestUI();
            });
        });

        openWardrobeButton.addEventListener('click', () => {
            setupWardrobeScreen();
            showGameSubScreen(wardrobeScreen);
        });

        // Gardırop değişikliklerini onaylama
        confirmWardrobeChangeButton.addEventListener('click', applyWardrobeChange);

        // KARAKTER SAYFASI İÇİN OLAY DİNLEYİCİLERİ
        const characterSheetWindow = document.querySelector('.character-sheet-window');
        let draggedItemInfo = null;

        // Sürükleme Başlangıcı
        characterSheetWindow.addEventListener('dragstart', (e) => {
            const target = e.target.closest('[draggable="true"]');
            if (!target) return;
            
            draggedItemInfo = {
                type: target.dataset.itemType,
                itemId: target.dataset.itemId,
                inventoryIndex: target.dataset.inventoryIndex,
                slotKey: target.dataset.slotKey
            };
            e.dataTransfer.setData('text/plain', JSON.stringify(draggedItemInfo));
            setTimeout(() => target.classList.add('opacity-50'), 0); // Görsel geri bildirim
        });

        // Sürükleme Bitişi
        characterSheetWindow.addEventListener('dragend', (e) => {
            const target = e.target.closest('[draggable="true"]');
            if (target) {
                target.classList.remove('opacity-50');
            }
            draggedItemInfo = null;
        });

        // Sürüklenerek Üzerine Gelme
        characterSheetWindow.addEventListener('dragover', (e) => {
            e.preventDefault();
            const dropTarget = e.target.closest('.equipment-slot, #character-inventory-grid');
            if(dropTarget) {
                 document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                 if(dropTarget.classList.contains('equipment-slot')) {
                     dropTarget.classList.add('drag-over');
                 }
            }
        });

        characterSheetWindow.addEventListener('dragleave', (e) => {
             const dropTarget = e.target.closest('.equipment-slot');
             if(dropTarget) dropTarget.classList.remove('drag-over');
        });

        // Bırakma
        characterSheetWindow.addEventListener('drop', (e) => {
            e.preventDefault();
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            const dropTarget = e.target.closest('.equipment-slot, #character-inventory-grid');
            if (!dropTarget || !draggedItemInfo) return;

            // Ekipman slotuna bırakma (Giyme)
            if (dropTarget.classList.contains('equipment-slot')) {
                if (draggedItemInfo.type !== 'inventory') return; // Sadece envanterden giyilebilir
                
                const itemData = GAME_ITEMS[draggedItemInfo.itemId];
                const itemSlotType = itemData.subCategory || itemData.category;
                const targetSlotType = dropTarget.dataset.slotType;

                if (itemSlotType === targetSlotType) {
                    equipItem(parseInt(draggedItemInfo.inventoryIndex));
                }
            }
            // Envantere bırakma (Çıkarma)
            else if (dropTarget.id === 'character-inventory-grid') {
                if (draggedItemInfo.type !== 'equipment') return; // Sadece ekipmandan çıkarılabilir
                unequipItem(draggedItemInfo.slotKey);
            }
        });

        // Çift Tıklama
        characterSheetWindow.addEventListener('dblclick', (e) => {
            const target = e.target.closest('[data-item-id]');
            if (!target) return;
            
            const itemType = target.dataset.itemType;
            if (itemType === 'inventory') {
                equipItem(parseInt(target.dataset.inventoryIndex));
            } else if (itemType === 'equipment') {
                unequipItem(target.dataset.slotKey);
            }
        });

        function renderQuickSellScreen() {
            if (!currentUserData) return;
            quickSellInventoryGrid.innerHTML = '';
            quickSellSelectedIndices = []; // Ekran her yenilendiğinde seçimi sıfırla
            updateQuickSellTotal();

            currentUserData.inventory.forEach((item, index) => {
                if (item && GAME_ITEMS[item.id]) {
                    const itemData = GAME_ITEMS[item.id];
                    const slot = document.createElement('div');
                    slot.className = 'inventory-slot rounded-lg flex items-center justify-center cursor-pointer';
                    slot.innerHTML = itemData.icon;
                    slot.dataset.inventoryIndex = index; // Orijinal envanterdeki index'ini sakla
                    
                    slot.addEventListener('mouseenter', () => showItemTooltip(item, slot));
                    slot.addEventListener('mouseleave', hideItemTooltip);
                    
                    quickSellInventoryGrid.appendChild(slot);
                }
            });
        }

        function updateQuickSellTotal() {
            let totalValue = 0;
            quickSellSelectedIndices.forEach(index => {
                const item = currentUserData.inventory[index];
                if (item && GAME_ITEMS[item.id]) {
                    totalValue += GAME_ITEMS[item.id].sellPrice;
                }
            });
            quickSellTotal.textContent = `${totalValue} 💰`;
            quickSellConfirmButton.disabled = totalValue === 0;
            document.getElementById('confirm-sell-price').textContent = `${totalValue} 💰`;
        }

        quickSellInventoryGrid.addEventListener('click', (e) => {
            const slot = e.target.closest('.inventory-slot');
            if (!slot) return;

            const index = parseInt(slot.dataset.inventoryIndex);
            const selectionIndex = quickSellSelectedIndices.indexOf(index);

            if (selectionIndex > -1) {
                // Zaten seçili, seçimi kaldır
                quickSellSelectedIndices.splice(selectionIndex, 1);
                slot.classList.remove('selected');
            } else {
                // Seçili değil, seç
                quickSellSelectedIndices.push(index);
                slot.classList.add('selected');
            }
            updateQuickSellTotal();
        });

        quickSellConfirmButton.addEventListener('click', () => {
            if (quickSellSelectedIndices.length > 0) {
                quickSellConfirmationModal.classList.remove('hidden');
            }
        });

        confirmSellNoBtn.addEventListener('click', () => {
            quickSellConfirmationModal.classList.add('hidden');
        });

        confirmSellYesBtn.addEventListener('click', async () => {
            if (quickSellSelectedIndices.length === 0) return;

            const userRef = doc(db, "users", auth.currentUser.uid);
            try {
                await runTransaction(db, async (transaction) => {
                    const userDoc = await transaction.get(userRef);
                    if (!userDoc.exists()) throw "Kullanıcı bulunamadı!";
                    
                    const currentGold = userDoc.data().gold;
                    const currentInventory = userDoc.data().inventory;
                    
                    let goldToAdd = 0;
                    const newInventory = currentInventory.filter((item, index) => {
                        if (quickSellSelectedIndices.includes(index)) {
                            goldToAdd += GAME_ITEMS[item.id].sellPrice;
                            return false; // Bu eşyayı yeni envanterden çıkar
                        }
                        return true; // Bu eşyayı koru
                    });
                    
                    transaction.update(userRef, {
                        inventory: newInventory,
                        gold: currentGold + goldToAdd
                    });
                });
                console.log("Satış başarılı!");
                quickSellConfirmationModal.classList.add('hidden');
                // onSnapshot sayesinde UI otomatik güncellenecek, sadece yerel seçimleri sıfırlamamız yeterli
                renderQuickSellScreen(); 
            } catch (error) {
                console.error("Satış sırasında hata:", error);
                quickSellConfirmationModal.classList.add('hidden');
            }
        });
        
    </script>
</body>
</html>